<!-- 
  ANTHROPIC USAGE WIDGET
  Enterprise-level dashboard widget for NorthStar Synergy
  Displays real-time Anthropic API cost tracking
-->

<div id="anthropic-widget" class="widget anthropic-widget">
  <div class="widget-header">
    <h2>ðŸ¤– Anthropic API Usage</h2>
    <button onclick="refreshAnthropicWidget()" title="Refresh">âŸ³</button>
  </div>

  <div class="widget-body">
    <!-- Quick Stats -->
    <div class="quick-stats">
      <div class="stat-card">
        <div class="stat-label">Today's Cost</div>
        <div class="stat-value" id="today-cost">$0.00</div>
        <div class="stat-detail" id="today-tokens">0 tokens</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">This Week</div>
        <div class="stat-value" id="week-cost">$0.00</div>
        <div class="stat-detail" id="week-requests">0 requests</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">Requests Today</div>
        <div class="stat-value" id="today-requests">0</div>
        <div class="stat-detail" id="avg-cost-per-request">$0.00 avg</div>
      </div>
    </div>

    <!-- Breakdown Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('model')">By Model</button>
      <button class="tab-btn" onclick="switchTab('agent')">By Agent</button>
      <button class="tab-btn" onclick="switchTab('daily')">Daily Trend</button>
    </div>

    <!-- By Model -->
    <div id="tab-model" class="tab-content active">
      <table class="usage-table">
        <thead>
          <tr>
            <th>Model</th>
            <th>Tokens</th>
            <th>Cost</th>
            <th>Requests</th>
          </tr>
        </thead>
        <tbody id="model-table-body">
          <tr><td colspan="4" style="text-align:center">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- By Agent -->
    <div id="tab-agent" class="tab-content" style="display:none">
      <table class="usage-table">
        <thead>
          <tr>
            <th>Agent</th>
            <th>Tokens</th>
            <th>Cost</th>
            <th>Requests</th>
            <th>% of Total</th>
          </tr>
        </thead>
        <tbody id="agent-table-body">
          <tr><td colspan="5" style="text-align:center">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Daily Trend -->
    <div id="tab-daily" class="tab-content" style="display:none">
      <table class="usage-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Tokens</th>
            <th>Cost</th>
            <th>Requests</th>
          </tr>
        </thead>
        <tbody id="daily-table-body">
          <tr><td colspan="4" style="text-align:center">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Last Sync Info -->
    <div class="widget-footer">
      <small>Last updated: <span id="last-sync">Never</span></small>
      <button onclick="syncAnthropicNow()" class="sync-btn">Sync Now</button>
    </div>
  </div>
</div>

<style>
.anthropic-widget {
  background: #1a1a2e;
  border: 1px solid #16213e;
  border-radius: 8px;
  padding: 20px;
  margin: 10px 0;
  color: #eee;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.widget-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.widget-header h2 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.widget-header button {
  background: #16213e;
  border: 1px solid #0f3460;
  color: #00d4ff;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

.widget-header button:hover {
  background: #0f3460;
}

.quick-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.stat-card {
  background: #16213e;
  border: 1px solid #0f3460;
  border-radius: 6px;
  padding: 15px;
  text-align: center;
}

.stat-label {
  font-size: 12px;
  color: #aaa;
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stat-value {
  font-size: 24px;
  font-weight: bold;
  color: #00d4ff;
  margin-bottom: 5px;
}

.stat-detail {
  font-size: 11px;
  color: #777;
}

.tabs {
  display: flex;
  gap: 5px;
  margin-bottom: 15px;
  border-bottom: 1px solid #16213e;
}

.tab-btn {
  background: transparent;
  border: none;
  color: #aaa;
  padding: 10px 15px;
  cursor: pointer;
  font-size: 13px;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}

.tab-btn.active {
  color: #00d4ff;
  border-bottom-color: #00d4ff;
}

.tab-btn:hover {
  color: #00d4ff;
}

.tab-content {
  display: none;
  animation: fadeIn 0.2s;
}

.tab-content.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.usage-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.usage-table thead {
  background: #16213e;
  border-bottom: 1px solid #0f3460;
}

.usage-table th {
  padding: 10px;
  text-align: left;
  color: #aaa;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 11px;
  letter-spacing: 0.5px;
}

.usage-table td {
  padding: 10px;
  border-bottom: 1px solid #16213e;
}

.usage-table tbody tr:hover {
  background: #16213e;
}

.widget-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #16213e;
  font-size: 12px;
}

.sync-btn {
  background: #00d4ff;
  border: none;
  color: #1a1a2e;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 600;
  font-size: 12px;
}

.sync-btn:hover {
  background: #00a8cc;
}

#last-sync {
  color: #00d4ff;
  font-weight: 600;
}
</style>

<script>
let lastSync = null;

async function loadAnthropicData(days = 1) {
  try {
    const response = await fetch(`/api/usage/anthropic?days=${days}`);
    const data = await response.json();
    
    if (!response.ok) {
      console.error('[WIDGET] Error:', data);
      return null;
    }

    return data;
  } catch (err) {
    console.error('[WIDGET] Fetch error:', err);
    return null;
  }
}

async function refreshAnthropicWidget() {
  const data = await loadAnthropicData(1);
  
  if (!data) {
    alert('Failed to load Anthropic usage data');
    return;
  }

  // Update quick stats
  const total = data.total || { total_tokens: 0, total_cost: 0, request_count: 0 };
  document.getElementById('today-cost').textContent = `$${total.total_cost?.toFixed(2) || '0.00'}`;
  document.getElementById('today-tokens').textContent = `${total.total_tokens || 0} tokens`;
  document.getElementById('today-requests').textContent = total.request_count || '0';

  const avgCost = total.request_count > 0 ? total.total_cost / total.request_count : 0;
  document.getElementById('avg-cost-per-request').textContent = `$${avgCost.toFixed(4)} avg`;

  // Update by model table
  const modelBody = document.getElementById('model-table-body');
  if (data.by_model && data.by_model.length > 0) {
    modelBody.innerHTML = data.by_model.map(m => `
      <tr>
        <td>${m.model}</td>
        <td>${m.total_tokens || 0}</td>
        <td>$${(m.total_cost || 0).toFixed(2)}</td>
        <td>${m.request_count || 0}</td>
      </tr>
    `).join('');
  } else {
    modelBody.innerHTML = '<tr><td colspan="4" style="text-align:center">No data</td></tr>';
  }

  // Update by agent table
  const agentBody = document.getElementById('agent-table-body');
  if (data.by_agent && data.by_agent.length > 0) {
    const totalCost = data.by_agent.reduce((sum, a) => sum + (a.total_cost || 0), 0);
    agentBody.innerHTML = data.by_agent.map(a => {
      const pct = totalCost > 0 ? ((a.total_cost || 0) / totalCost * 100).toFixed(1) : 0;
      return `
        <tr>
          <td>${a.agent_id}</td>
          <td>${a.total_tokens || 0}</td>
          <td>$${(a.total_cost || 0).toFixed(2)}</td>
          <td>${a.request_count || 0}</td>
          <td>${pct}%</td>
        </tr>
      `;
    }).join('');
  } else {
    agentBody.innerHTML = '<tr><td colspan="5" style="text-align:center">No data</td></tr>';
  }

  // Update daily table
  const dailyBody = document.getElementById('daily-table-body');
  if (data.by_date && data.by_date.length > 0) {
    dailyBody.innerHTML = data.by_date.map(d => `
      <tr>
        <td>${d.usage_date}</td>
        <td>${d.total_tokens || 0}</td>
        <td>$${(d.total_cost || 0).toFixed(2)}</td>
        <td>${d.request_count || 0}</td>
      </tr>
    `).join('');
  } else {
    dailyBody.innerHTML = '<tr><td colspan="4" style="text-align:center">No data</td></tr>';
  }

  // Update last sync
  lastSync = new Date();
  document.getElementById('last-sync').textContent = lastSync.toLocaleTimeString();
}

function switchTab(tabName) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });

  // Deactivate all buttons
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });

  // Show selected tab
  document.getElementById(`tab-${tabName}`).classList.add('active');
  event.target.classList.add('active');
}

async function syncAnthropicNow() {
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = 'Syncing...';

  try {
    const response = await fetch('/api/usage/sync-anthropic', { method: 'POST' });
    const result = await response.json();
    
    console.log('[WIDGET] Sync result:', result);
    
    // Refresh data after sync
    await refreshAnthropicWidget();
    
    btn.textContent = 'Synced âœ“';
    setTimeout(() => {
      btn.textContent = 'Sync Now';
      btn.disabled = false;
    }, 2000);
  } catch (err) {
    console.error('[WIDGET] Sync error:', err);
    btn.textContent = 'Sync Failed';
    btn.disabled = false;
  }
}

// Auto-refresh on load
document.addEventListener('DOMContentLoaded', () => {
  refreshAnthropicWidget();
  // Refresh every 5 minutes
  setInterval(refreshAnthropicWidget, 300000);
});
</script>
