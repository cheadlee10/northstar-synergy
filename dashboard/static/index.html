<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>NorthStar Synergy | Command Center</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.0/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#070b14;--card:#0d1224;--card-hover:#131a33;--elevated:#1a2240;
  --border:rgba(136,150,171,0.1);--border-light:rgba(136,150,171,0.06);
  --green:#00d395;--green-dim:rgba(0,211,149,0.12);
  --red:#ff3b5c;--red-dim:rgba(255,59,92,0.12);
  --blue:#4f8ef7;--blue-dim:rgba(79,142,247,0.12);
  --purple:#9b59ff;--purple-dim:rgba(155,89,255,0.12);
  --amber:#f5a623;--amber-dim:rgba(245,166,35,0.12);
  --text:#e2e8f0;--text2:#8896ab;--muted:#4a5568;
  --font:'Outfit',system-ui,sans-serif;
  --mono:'IBM Plex Mono',monospace;
}
html{font-size:14px}
body{background:var(--bg);color:var(--text);font-family:var(--font);min-height:100vh;overflow-x:hidden}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:#1a2240;border-radius:3px}

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header{position:sticky;top:0;z-index:100;background:rgba(7,11,20,0.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--border)}
.header-inner{max-width:1480px;margin:0 auto;padding:0 24px}
.header-top{display:flex;justify-content:space-between;align-items:center;padding:14px 0 0}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#4f8ef7,#9b59ff);display:flex;align-items:center;justify-content:center;font:800 15px/1 var(--mono);color:#fff;letter-spacing:-0.5px}
.logo-text h1{font-size:17px;font-weight:800;letter-spacing:-0.03em}
.logo-text span{font-size:9px;text-transform:uppercase;letter-spacing:0.12em;color:var(--text2);font-weight:600}
.header-right{display:flex;align-items:center;gap:16px}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.live-label{font:600 10px/1 var(--mono);color:var(--green);letter-spacing:0.05em}
.updated{font:500 10px/1 var(--font);color:var(--muted)}

/* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs{display:flex;gap:0;margin-top:6px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.tab{padding:10px 18px;font:600 12px/1 var(--font);color:var(--muted);background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;white-space:nowrap;transition:all .15s}
.tab:hover{color:var(--text)}
.tab.active{color:var(--blue);border-bottom-color:var(--blue)}

/* â”€â”€ Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.content{max-width:1480px;margin:0 auto;padding:20px 24px 60px}
.grid{display:grid;gap:12px}
.g2{grid-template-columns:repeat(2,1fr)}
.g3{grid-template-columns:repeat(3,1fr)}
.g4{grid-template-columns:repeat(4,1fr)}
.g6{grid-template-columns:repeat(6,1fr)}
.g8-4{grid-template-columns:2fr 1fr}
.span2{grid-column:span 2}

/* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card{background:var(--card);border:1px solid var(--border-light);border-radius:12px;overflow:hidden}
.card-p{padding:20px}
.card-header{font:700 10px/1 var(--font);color:var(--muted);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:14px}

/* â”€â”€ KPI Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kpi{padding:18px 20px;border-top:3px solid transparent;position:relative}
.kpi-label{font:600 10px/1 var(--font);color:var(--text2);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:8px}
.kpi-value{font:700 24px/1.1 var(--mono);letter-spacing:-0.02em}
.kpi-sub{font:500 11px/1.3 var(--font);color:var(--muted);margin-top:6px}
.kpi-spark{position:absolute;bottom:0;left:0;right:0;height:32px;opacity:0.4}

/* â”€â”€ Badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge{display:inline-block;padding:2px 8px;border-radius:20px;font:600 10px/1.4 var(--mono);letter-spacing:0.02em}
.badge-green{background:var(--green-dim);color:var(--green)}
.badge-red{background:var(--red-dim);color:var(--red)}
.badge-blue{background:var(--blue-dim);color:var(--blue)}
.badge-amber{background:var(--amber-dim);color:var(--amber)}
.badge-purple{background:var(--purple-dim);color:var(--purple)}

/* â”€â”€ Tables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
table{width:100%;border-collapse:collapse}
th{text-align:left;font:700 9px/1 var(--font);color:var(--muted);text-transform:uppercase;letter-spacing:0.1em;padding:10px 14px;border-bottom:1px solid var(--border)}
td{padding:10px 14px;font-size:12px;border-bottom:1px solid var(--border-light)}
tr:hover td{background:rgba(255,255,255,0.015)}
.mono{font-family:var(--mono)}
.green{color:var(--green)}.red{color:var(--red)}.blue{color:var(--blue)}.amber{color:var(--amber)}.purple{color:var(--purple)}
.fw7{font-weight:700}

/* â”€â”€ Chart containers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chart-wrap{position:relative}
.chart-wrap canvas{width:100%!important}

/* â”€â”€ Segment cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.seg{border-left:3px solid var(--blue)}
.seg-icon{font-size:20px;margin-right:8px}
.seg-name{font:700 14px/1 var(--font)}
.seg-value{font:700 28px/1.1 var(--mono);margin:12px 0 4px}
.seg-detail{font:500 11px/1.3 var(--font);color:var(--muted)}

/* â”€â”€ Loading & error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loading{padding:80px 0;text-align:center;color:var(--muted);font-size:13px}
.error{padding:40px;color:var(--red);font-family:var(--mono);font-size:12px}
.retry-btn{margin-top:12px;padding:8px 20px;background:var(--blue);color:#fff;border:none;border-radius:8px;font:600 12px/1 var(--font);cursor:pointer}

/* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty{padding:60px 0;text-align:center}
.empty-icon{font-size:36px;margin-bottom:12px}
.empty-title{font:600 15px/1 var(--font);margin-bottom:6px}
.empty-desc{font:500 12px/1.4 var(--font);color:var(--muted);max-width:320px;margin:0 auto}

/* â”€â”€ Pagination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pagination{display:flex;align-items:center;gap:10px;justify-content:flex-end;margin-top:12px}
.page-btn{padding:5px 14px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font:500 12px/1 var(--font);cursor:pointer}
.page-btn:disabled{opacity:.3;cursor:default}
.page-info{font:500 11px/1 var(--font);color:var(--muted)}

/* â”€â”€ Section title â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-title{font:700 10px/1 var(--font);color:var(--muted);text-transform:uppercase;letter-spacing:0.1em;margin:28px 0 14px}

/* â”€â”€ Attribution waterfall â”€â”€ */
.wf-summary{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;font:500 11px/1.3 var(--font);color:var(--text2);margin-bottom:12px}
.wf-grid{display:grid;gap:10px}
.wf-row{display:grid;grid-template-columns:minmax(140px,1.4fr) minmax(120px,2fr) auto;gap:10px;align-items:center}
.wf-label{font:600 11px/1.2 var(--font)}
.wf-desc{font:500 10px/1.2 var(--font);color:var(--muted);margin-top:2px}
.wf-bar-wrap{height:10px;background:#1a2240;border-radius:99px;overflow:hidden}
.wf-bar{height:100%;border-radius:99px}
.wf-bar.pos{background:linear-gradient(90deg,rgba(0,211,149,.6),rgba(0,211,149,1))}
.wf-bar.neg{background:linear-gradient(90deg,rgba(255,59,92,.6),rgba(255,59,92,1))}
.wf-amount{font:700 12px/1 var(--mono);white-space:nowrap}

/* â”€â”€ Executive exception queue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.exq-head{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;margin-bottom:12px;flex-wrap:wrap}
.exq-metrics{display:flex;gap:8px;flex-wrap:wrap}
.exq-chip{padding:4px 8px;border:1px solid var(--border);border-radius:8px;background:#0b1020;font:600 10px/1 var(--mono);color:var(--text2)}
.exq-table{width:100%;border-collapse:collapse}
.exq-table th,.exq-table td{padding:8px 10px;font-size:11px;vertical-align:top}
.exq-pri{font:700 11px/1 var(--mono)}
.exq-owner{font:600 11px/1.2 var(--font)}
.exq-note{font:500 10px/1.3 var(--font);color:var(--muted);margin-top:3px}
.exq-sla{font:600 10px/1 var(--mono)}

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:1200px){.g6{grid-template-columns:repeat(3,1fr)}.g4{grid-template-columns:repeat(2,1fr)}.g8-4{grid-template-columns:1fr}}
@media(max-width:768px){.g3,.g2{grid-template-columns:1fr}.g6{grid-template-columns:repeat(2,1fr)}.tabs{gap:0}.tab{padding:10px 12px;font-size:11px}.wf-row{grid-template-columns:1fr}.wf-bar-wrap{height:8px}.exq-table th,.exq-table td{padding:7px 6px;font-size:10px}}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â• -->
<div class="header">
<div class="header-inner">
  <div class="header-top">
    <div class="logo">
      <div class="logo-icon">NS</div>
      <div class="logo-text">
        <h1>NorthStar Synergy</h1>
        <span>Intelligence Â· Operations Â· Profit</span>
      </div>
    </div>
    <div class="header-right">
      <span class="updated" id="lastUpdate"></span>
      <div style="display:flex;align-items:center;gap:6px">
        <div class="live-dot"></div>
        <span class="live-label">LIVE</span>
      </div>
    </div>
  </div>
  <div class="tabs" id="tabBar"></div>
</div>
</div>

<!-- â•â•â•â•â•â•â• CONTENT â•â•â•â•â•â•â• -->
<div class="content" id="app">
  <div class="loading">âš¡ Loading Command Center...</div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NORTHSTAR SYNERGY â€” ENTERPRISE P&L COMMAND CENTER
   Chart.js + ApexCharts Â· Vanilla JS Â· Zero build step
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ Chart.js global defaults â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Chart.defaults.color = '#8896ab';
Chart.defaults.borderColor = 'rgba(136,150,171,0.08)';
Chart.defaults.font.family = "'Outfit', system-ui, sans-serif";
Chart.defaults.font.size = 11;
Chart.defaults.plugins.legend.display = false;
Chart.defaults.plugins.tooltip.backgroundColor = '#0d1224';
Chart.defaults.plugins.tooltip.borderColor = 'rgba(136,150,171,0.2)';
Chart.defaults.plugins.tooltip.borderWidth = 1;
Chart.defaults.plugins.tooltip.cornerRadius = 8;
Chart.defaults.plugins.tooltip.titleFont = {family:"'Outfit'",weight:'600',size:11};
Chart.defaults.plugins.tooltip.bodyFont = {family:"'IBM Plex Mono'",size:11};
Chart.defaults.plugins.tooltip.padding = 10;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let STATE = { tab: 'exceptions', data: null, trades: null, health: null, charts: {} };
const $ = id => document.getElementById(id);
const app = $('app');

// â”€â”€ Formatting helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt = (n, d=2) => {
  if (n == null || isNaN(n)) return '$0.00';
  return (n<0?'-$':'$') + Math.abs(n).toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d});
};
const fmtPct = (n,d=1) => isNaN(n)?'0.0%':(n*100).toFixed(d)+'%';
const fmtNum = n => isNaN(n)?'0':Number(n).toLocaleString();
const clr = (n,zero='var(--text)') => n>0?'var(--green)':n<0?'var(--red)':zero;

// â”€â”€ Chart management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function destroyChart(id) {
  if (STATE.charts[id]) { STATE.charts[id].destroy(); delete STATE.charts[id]; }
}
function destroyAllCharts() {
  Object.keys(STATE.charts).forEach(destroyChart);
}

// â”€â”€ Tab definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TABS = [
  {id:'exceptions', label:'Exec Exceptions'},
  {id:'pnl',   label:'P&L Overview'},
  {id:'kalshi', label:'âš¡ Kalshi Analytics'},
  {id:'sports', label:'Sports Picks'},
  {id:'john',  label:"John's Biz"},
  {id:'costs', label:'Cost Drill-Down'},
  {id:'ledger',label:'Ledger'},
];

// â”€â”€ Render tab bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTabs() {
  $('tabBar').innerHTML = TABS.map(t =>
    `<button class="tab${STATE.tab===t.id?' active':''}" data-tab="${t.id}">${t.label}</button>`
  ).join('');
  $('tabBar').querySelectorAll('.tab').forEach(btn => {
    btn.onclick = () => { STATE.tab = btn.dataset.tab; renderTabs(); renderContent(); };
  });
}

// â”€â”€ Build KPI card HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function kpi(label, value, opts={}) {
  const {color='var(--text)',border='transparent',sub='',raw=false} = opts;
  return `<div class="card kpi" style="border-top-color:${border}">
    <div class="kpi-label">${label}</div>
    <div class="kpi-value" style="color:${color}">${raw?value:fmt(value)}</div>
    ${sub?`<div class="kpi-sub">${sub}</div>`:''}
  </div>`;
}

function renderAttributionWaterfall(d) {
  const attribution = d.pnl_attribution || {steps: []};
  const steps = attribution.steps || [];
  const maxAbs = Math.max(...steps.map(s => Math.abs(Number(s.amount || 0))), 1);

  const rows = steps.map(step => {
    const amt = Number(step.amount || 0);
    const isPos = amt >= 0;
    const width = Math.max(6, (Math.abs(amt) / maxAbs) * 100);
    return `<div class="wf-row">
      <div>
        <div class="wf-label">${step.label}</div>
        <div class="wf-desc">${step.description || ''}</div>
      </div>
      <div class="wf-bar-wrap">
        <div class="wf-bar ${isPos ? 'pos' : 'neg'}" style="width:${width}%"></div>
      </div>
      <div class="wf-amount ${isPos ? 'green' : 'red'}">${isPos ? '+' : '-'}${fmt(Math.abs(amt))}</div>
    </div>`;
  }).join('');

  return `<div class="card card-p" style="margin-bottom:12px">
    <div class="card-header">Net Profit Attribution Waterfall</div>
    <div class="wf-summary">
      <span>Start: <span class="mono">${fmt(attribution.starting_value || 0)}</span></span>
      <span>End: <span class="mono" style="color:${clr(d.total_profit || 0)}">${fmt(attribution.ending_value ?? d.total_profit ?? 0)}</span></span>
    </div>
    <div class="wf-grid">${rows}</div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB: P&L OVERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPnL(d) {
  const net = d.betting_net - (d.openrouter_total_spend||0);
  const creditsLeft = d.openrouter_credits_remaining||0;

  let html = `
  <div class="grid g4" style="margin-bottom:12px">
    ${kpi('True Net P&L', net, {color:clr(net), border:net>=0?'var(--green)':'var(--red)', sub:'Betting P&L minus API costs'})}
    ${kpi('Betting Wins', d.betting_wins, {color:'var(--green)', border:'var(--green)', sub:fmtNum(d.total_trades)+' settled trades'})}
    ${kpi('Betting Losses', d.betting_losses, {color:'var(--red)', border:'var(--red)', sub:fmtPct(d.win_rate)+' win rate'})}
    ${kpi('Betting Net', d.betting_net, {color:clr(d.betting_net), border:'var(--purple)', sub:'Gross prediction market P&L'})}
  </div>
  <div class="grid g4" style="margin-bottom:12px">
    ${kpi('Sharpe Ratio', d.sharpe_ratio?.toFixed(2)||'0.00', {color:d.sharpe_ratio>=1?'var(--green)':d.sharpe_ratio>=0?'var(--amber)':'var(--red)', border:'var(--blue)', raw:true, sub:d.sharpe_ratio>=1?'Strong risk-adjusted':'Needs improvement'})}
    ${kpi('Max Drawdown', d.max_drawdown, {color:d.drawdown_zone==='red'?'var(--red)':d.drawdown_zone==='amber'?'var(--amber)':'var(--green)', border:d.drawdown_zone==='red'?'var(--red)':d.drawdown_zone==='amber'?'var(--amber)':'var(--green)', sub:`${(d.max_drawdown_pct||0).toFixed(1)}% · ${(d.max_drawdown_days||0)}d`})}
    ${kpi('Open Positions', fmtNum(d.open_positions), {color:'var(--blue)', border:'var(--blue)', raw:true, sub:fmt(d.open_exposure)+' exposure'})}
    ${kpi('Kelly %', fmtPct(d.kelly_pct), {color:d.kelly_pct>0?'var(--green)':'var(--red)', border:d.kelly_pct>0?'var(--green)':'var(--red)', raw:true, sub:d.kelly_pct>0?'Positive edge detected':'Negative edge â€” reduce size'})}
  </div>

  ${renderAttributionWaterfall(d)}

  <!-- Drawdown & recovery analytics -->
  <div class="grid g2" style="margin-bottom:12px">
    <div class="card card-p">
      <div class="card-header">Cumulative P&L â€” EOD Equity Curve</div>
      <div class="chart-wrap" style="height:240px"><canvas id="chartEquity"></canvas></div>
    </div>
    <div class="card card-p">
      <div class="card-header">Underwater Drawdown (EOD)</div>
      <div class="chart-wrap" style="height:240px"><canvas id="chartUnderwater"></canvas></div>
    </div>
  </div>
  <div class="grid g2" style="margin-bottom:12px">
    <div class="card card-p">
      <div class="card-header">Daily P&L (EOD deltas)</div>
      <div class="chart-wrap" style="height:210px"><canvas id="chartDaily"></canvas></div>
    </div>
    <div class="card card-p">
      <div class="card-header">Recovery Durations</div>
      <div style="max-height:210px;overflow:auto">
        ${(d.recovery_markers||[]).length ? `<table><thead><tr><th>Drawdown Start</th><th>Recovered</th><th>Days</th></tr></thead><tbody>${d.recovery_markers.slice(-8).reverse().map(m=>`<tr><td class="mono">${m.drawdown_start}</td><td class="mono">${m.recovered_on}</td><td class="mono fw7" style="color:${m.duration_days>10?'var(--red)':m.duration_days>5?'var(--amber)':'var(--green)'}">${m.duration_days}</td></tr>`).join('')}</tbody></table>` : `<div class="empty-desc" style="padding:30px 0">No completed recovery cycles yet.</div>`}
      </div>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        <span class="badge badge-green">Green ≤ $${(d.drawdown_thresholds?.green?.max_dd_usd||250).toFixed(0)}</span>
        <span class="badge badge-amber">Amber ≤ $${(d.drawdown_thresholds?.amber?.max_dd_usd||750).toFixed(0)}</span>
        <span class="badge badge-red">Red &gt; $${(d.drawdown_thresholds?.amber?.max_dd_usd||750).toFixed(0)}</span>
      </div>
    </div>
  </div>

  <!-- Business Units -->
  <div class="section-title">Business Units</div>
  <div class="grid g3" style="margin-bottom:12px">
    <div class="card card-p seg" style="border-left-color:var(--purple)">
      <div style="display:flex;align-items:center;margin-bottom:12px">
        <span class="seg-icon" style="color:var(--purple)">âš¡</span>
        <span class="seg-name">Scalper / Kalshi</span>
      </div>
      <div class="seg-value" style="color:${clr(d.betting_net)}">${fmt(d.betting_net)}</div>
      <div class="seg-detail">Wins: ${fmt(d.betting_wins)} Â· ${fmtNum(d.total_trades)} trades Â· ${fmtPct(d.win_rate)} win rate</div>
      <div class="seg-detail">${d.current_streak||0}${d.streak_type||'?'} streak Â· ${d.open_positions} open</div>
    </div>
    <div class="card card-p seg" style="border-left-color:var(--green)">
      <div style="display:flex;align-items:center;margin-bottom:12px">
        <span class="seg-icon" style="color:var(--green)">â—†</span>
        <span class="seg-name">John's Web Biz</span>
      </div>
      <div class="seg-value" style="color:${clr(d.john_revenue||0)}">${fmt(d.john_revenue||0)}</div>
      <div class="seg-detail">Actual cash received (counts in net profit)</div>
      <div class="seg-detail">Pipeline only: ${fmt(d.john_pipeline||0)} (does not count in net)</div>
    </div>
    <div class="card card-p seg" style="border-left-color:var(--amber)">
      <div style="display:flex;align-items:center;margin-bottom:12px">
        <span class="seg-icon" style="color:var(--amber)">âœ¦</span>
        <span class="seg-name">Kelsea</span>
      </div>
      <div class="seg-value" style="color:var(--muted)">$0.00</div>
      <div class="seg-detail">Awaiting transaction data sync</div>
    </div>
  </div>

  <!-- API Cost Banner -->
  <div class="card card-p" style="border-left:3px solid var(--amber)">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px">
      <div>
        <div class="kpi-label">OpenRouter API Spend</div>
        <div style="font:700 26px/1 var(--mono);color:var(--amber)">${fmt(d.openrouter_total_spend)}</div>
      </div>
      <div style="text-align:center">
        <div class="kpi-label">Credits Left</div>
        <div style="font:700 22px/1 var(--mono);color:${creditsLeft<50?'var(--red)':'var(--green)'}">${fmt(creditsLeft)}</div>
        ${creditsLeft<50?'<div style="font:700 10px/1 var(--font);color:var(--red);margin-top:4px">âš  TOP UP SOON</div>':''}
      </div>
      <div style="text-align:right">
        <div class="kpi-label">True Bottom Line</div>
        <div style="font:700 22px/1 var(--mono);color:${clr(net)}">${fmt(net)}</div>
        <div style="font:500 10px/1 var(--font);color:var(--muted);margin-top:4px">Betting P&L âˆ’ API costs</div>
      </div>
    </div>
  </div>`;

  app.innerHTML = html;

  // â”€â”€ Equity curve chart â”€â”€
  if (d.cumulative_pnl?.length) {
    const ctx = $('chartEquity').getContext('2d');
    const grad = ctx.createLinearGradient(0,0,0,260);
    const isPos = d.betting_net >= 0;
    grad.addColorStop(0, isPos?'rgba(0,211,149,0.25)':'rgba(255,59,92,0.25)');
    grad.addColorStop(1, 'rgba(0,0,0,0)');
    destroyChart('equity');
    STATE.charts.equity = new Chart(ctx, {
      type:'line',
      data:{
        labels: d.cumulative_pnl.map(p=>p.date),
        datasets:[{data:d.cumulative_pnl.map(p=>p.pnl),borderColor:isPos?'#00d395':'#ff3b5c',borderWidth:2,fill:true,backgroundColor:grad,tension:0.3,pointRadius:0,pointHitRadius:8}]
      },
      options:{
        responsive:true, maintainAspectRatio:false, animation:false,
        scales:{
          x:{ticks:{maxTicksLimit:8,font:{size:10}},grid:{display:false}},
          y:{ticks:{callback:v=>'$'+v,font:{family:"'IBM Plex Mono'",size:10}},grid:{color:'rgba(136,150,171,0.05)'}}
        },
        plugins:{
          annotation:{annotations:{zero:{type:'line',yMin:0,yMax:0,borderColor:'rgba(136,150,171,0.2)',borderDash:[4,4],borderWidth:1}}},
          tooltip:{callbacks:{label:ctx=>fmt(ctx.parsed.y)}}
        }
      }
    });
  }

  // â”€â”€ Underwater drawdown chart â”€â”€
  if (d.underwater_drawdown?.length) {
    const ctxU = $('chartUnderwater').getContext('2d');
    destroyChart('underwater');
    const amberT = -Math.abs(d.drawdown_thresholds?.green?.max_dd_usd || 250);
    const redT = -Math.abs(d.drawdown_thresholds?.amber?.max_dd_usd || 750);
    STATE.charts.underwater = new Chart(ctxU, {
      type:'line',
      data:{
        labels: d.underwater_drawdown.map(p=>p.date),
        datasets:[{data:d.underwater_drawdown.map(p=>p.drawdown),borderColor:'#ff3b5c',borderWidth:2,fill:true,backgroundColor:'rgba(255,59,92,0.2)',tension:0.25,pointRadius:0}]
      },
      options:{
        responsive:true, maintainAspectRatio:false, animation:false,
        scales:{
          x:{ticks:{maxTicksLimit:8,font:{size:10}},grid:{display:false}},
          y:{ticks:{callback:v=>'$'+v,font:{family:"'IBM Plex Mono'",size:10}},grid:{color:'rgba(136,150,171,0.05)'}}
        },
        plugins:{
          annotation:{annotations:{
            zero:{type:'line',yMin:0,yMax:0,borderColor:'rgba(0,211,149,0.35)',borderWidth:1},
            amber:{type:'line',yMin:amberT,yMax:amberT,borderColor:'rgba(245,166,35,0.8)',borderDash:[6,4],borderWidth:1},
            red:{type:'line',yMin:redT,yMax:redT,borderColor:'rgba(255,59,92,0.8)',borderDash:[6,4],borderWidth:1}
          }},
          tooltip:{callbacks:{label:ctx=>`${fmt(ctx.parsed.y)} (${(d.underwater_drawdown[ctx.dataIndex]?.drawdown_pct||0).toFixed(1)}%)`}}
        }
      }
    });
  }

  // â”€â”€ Daily P&L bars â”€â”€
  if (d.daily_pnl?.length) {
    const ctx2 = $('chartDaily').getContext('2d');
    destroyChart('daily');
    STATE.charts.daily = new Chart(ctx2, {
      type:'bar',
      data:{
        labels: d.daily_pnl.map(p=>p.date),
        datasets:[{
          data: d.daily_pnl.map(p=>p.pnl),
          backgroundColor: d.daily_pnl.map(p=>p.pnl>=0?'rgba(0,211,149,0.7)':'rgba(255,59,92,0.7)'),
          borderRadius:3, borderSkipped:false
        }]
      },
      options:{
        responsive:true, maintainAspectRatio:false, animation:false,
        scales:{
          x:{ticks:{maxTicksLimit:6,font:{size:9}},grid:{display:false}},
          y:{ticks:{callback:v=>'$'+v,font:{family:"'IBM Plex Mono'",size:10}},grid:{color:'rgba(136,150,171,0.05)'}}
        },
        plugins:{tooltip:{callbacks:{label:ctx=>fmt(ctx.parsed.y)}}}
      }
    });
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB: KALSHI ANALYTICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderKalshi(d) {
  const bm = d.by_market || {};
  const bd = d.by_direction || {};
  const cal = d.calibration || [];
  const tw = d.top_wins || [];
  const tl = d.top_losses || [];

  // Sort markets by P&L
  const marketsSorted = Object.entries(bm).sort((a,b)=>b[1].pnl-a[1].pnl);

  let html = `
  <!-- Top metrics row -->
  <div class="grid g6" style="margin-bottom:12px">
    ${kpi('Total P&L', d.betting_net, {color:clr(d.betting_net), border:clr(d.betting_net)})}
    ${kpi('Win Rate', fmtPct(d.win_rate), {color:'var(--blue)', border:'var(--blue)', raw:true, sub:(d.unique_contracts||0)+'W / '+(Math.round((d.unique_contracts||0)*(1-(d.win_rate||0))))+'L by contract'})}
    ${kpi('Sharpe', (d.sharpe_ratio||0).toFixed(2), {color:d.sharpe_ratio>=1?'var(--green)':'var(--amber)', border:'var(--blue)', raw:true, sub:d.sharpe_ratio>=1?'Strong':'Needs work'})}
    ${kpi('Max Drawdown', d.max_drawdown, {color:'var(--red)', border:'var(--red)', sub:'Peak-to-trough loss'})}
    ${kpi('Kelly %', fmtPct(d.kelly_pct), {color:d.kelly_pct>0?'var(--green)':'var(--red)', border:d.kelly_pct>0?'var(--green)':'var(--red)', raw:true, sub:d.kelly_pct>0?'Edge present':'Negative edge'})}
    ${kpi('Avg Win / Loss', '', {border:'var(--purple)', raw:true, sub:`<span class="green">${fmt(d.avg_win)}</span> / <span class="red">${fmt(d.avg_loss)}</span>`})}
  </div>

  <!-- Equity + Calibration row -->
  <div class="grid g2" style="margin-bottom:12px">
    <div class="card card-p">
      <div class="card-header">Cumulative P&L â€” Equity Curve (Last 200 Trades)</div>
      <div class="chart-wrap" style="height:220px"><canvas id="chartEquityK"></canvas></div>
    </div>
    <div class="card card-p">
      <div class="card-header">Calibration â€” Entry Price vs Actual Win Rate</div>
      <div style="font:500 10px/1.3 var(--font);color:var(--muted);margin-bottom:10px">Bars above the diagonal = underconfident pricing (good). Below = overpaying.</div>
      <div class="chart-wrap" style="height:190px"><canvas id="chartCalibration"></canvas></div>
    </div>
  </div>

  <!-- Market category + Direction -->
  <div class="grid g2" style="margin-bottom:12px">
    <div class="card card-p">
      <div class="card-header">P&L by Market Category</div>
      <div class="chart-wrap" style="height:${Math.max(180, marketsSorted.length*32)}px"><canvas id="chartCategory"></canvas></div>
    </div>
    <div class="card card-p">
      <div class="card-header">YES vs NO Performance</div>
      <table>
        <thead><tr><th>Direction</th><th>Trades</th><th>Win Rate</th><th>Net P&L</th></tr></thead>
        <tbody>
          ${Object.entries(bd).map(([dir,s])=>`<tr>
            <td><span class="badge ${dir==='YES'?'badge-green':'badge-red'}">${dir}</span></td>
            <td class="mono">${fmtNum(s.count)}</td>
            <td style="color:${s.wins/Math.max(s.count,1)>0.5?'var(--green)':'var(--red)'}">
              ${fmtPct(s.wins/Math.max(s.count,1))}
            </td>
            <td class="mono fw7" style="color:${clr(s.pnl)}">${fmt(s.pnl)}</td>
          </tr>`).join('')}
        </tbody>
      </table>

      <div class="card-header" style="margin-top:20px">Open Positions (${d.open_positions})</div>
      <div style="max-height:160px;overflow-y:auto;font-size:11px;color:var(--muted)">
        ${d.open_positions>0?'View in Ledger tab for full details.':'No open positions.'}
      </div>
    </div>
  </div>

  <!-- Exposure heatmap + concentration alerts -->
  <div class="grid g2" style="margin-bottom:12px">
    <div class="card card-p">
      <div class="card-header">Open Exposure Heatmap (Kalshi + Sports)</div>
      <div id="riskHeatmapWrap" style="font-size:12px;color:var(--text2)">Loading exposure map...</div>
    </div>
    <div class="card card-p">
      <div class="card-header">Concentration Alerts</div>
      <div id="riskAlertWrap" style="font-size:12px;color:var(--text2)">Loading concentration checks...</div>
    </div>
  </div>

  <!-- Top Wins & Losses -->
  <div class="grid g2">
    <div class="card card-p">
      <div class="card-header green">ðŸ† Top 5 Wins</div>
      <table>
        <thead><tr><th>Market</th><th>Entry</th><th>P&L</th></tr></thead>
        <tbody>${tw.map(t=>`<tr>
          <td style="font-size:11px;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.market||'â€”'}</td>
          <td class="mono" style="font-size:11px">${t.entry?((t.entry*100).toFixed(0)+'Â¢'):'â€”'}</td>
          <td class="mono fw7 green">+${fmt(t.pnl)}</td>
        </tr>`).join('')}</tbody>
      </table>
    </div>
    <div class="card card-p">
      <div class="card-header red">ðŸ’€ Top 5 Losses</div>
      <table>
        <thead><tr><th>Market</th><th>Entry</th><th>P&L</th></tr></thead>
        <tbody>${tl.map(t=>`<tr>
          <td style="font-size:11px;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.market||'â€”'}</td>
          <td class="mono" style="font-size:11px">${t.entry?((t.entry*100).toFixed(0)+'Â¢'):'â€”'}</td>
          <td class="mono fw7 red">${fmt(t.pnl)}</td>
        </tr>`).join('')}</tbody>
      </table>
    </div>
  </div>`;

  app.innerHTML = html;

  // â”€â”€ Equity Curve (Kalshi tab) â”€â”€
  if (d.cumulative_pnl?.length) {
    const ctx = $('chartEquityK').getContext('2d');
    const grad = ctx.createLinearGradient(0,0,0,220);
    const pos = d.betting_net>=0;
    grad.addColorStop(0, pos?'rgba(0,211,149,0.2)':'rgba(255,59,92,0.2)');
    grad.addColorStop(1, 'rgba(0,0,0,0)');
    destroyChart('equityK');
    STATE.charts.equityK = new Chart(ctx, {
      type:'line',
      data:{
        labels:d.cumulative_pnl.map(p=>p.date),
        datasets:[{data:d.cumulative_pnl.map(p=>p.pnl),borderColor:pos?'#00d395':'#ff3b5c',borderWidth:2,fill:true,backgroundColor:grad,tension:0.3,pointRadius:0}]
      },
      options:{
        responsive:true,maintainAspectRatio:false,animation:false,
        scales:{
          x:{ticks:{maxTicksLimit:6,font:{size:9}},grid:{display:false}},
          y:{ticks:{callback:v=>'$'+v,font:{family:"'IBM Plex Mono'",size:10}},grid:{color:'rgba(136,150,171,0.05)'}}
        },
        plugins:{
          annotation:{annotations:{zero:{type:'line',yMin:0,yMax:0,borderColor:'rgba(136,150,171,0.15)',borderDash:[4,4],borderWidth:1}}},
          tooltip:{callbacks:{label:c=>fmt(c.parsed.y)}}
        }
      }
    });
  }

  // â”€â”€ Calibration bar chart â”€â”€
  if (cal.length) {
    const ctx2 = $('chartCalibration').getContext('2d');
    destroyChart('calibration');
    STATE.charts.calibration = new Chart(ctx2, {
      type:'bar',
      data:{
        labels: cal.map(c=>c.range+'Â¢'),
        datasets:[{
          data: cal.map(c=>c.actual_win_rate),
          backgroundColor: cal.map(c=>c.actual_win_rate>0.5?'rgba(0,211,149,0.7)':'rgba(255,59,92,0.7)'),
          borderRadius:4,borderSkipped:false
        }]
      },
      options:{
        responsive:true,maintainAspectRatio:false,animation:false,
        indexAxis:'x',
        scales:{
          x:{ticks:{font:{size:10}},grid:{display:false}},
          y:{min:0,max:1,ticks:{callback:v=>(v*100)+'%',stepSize:0.25,font:{family:"'IBM Plex Mono'",size:10}},grid:{color:'rgba(136,150,171,0.05)'}}
        },
        plugins:{
          annotation:{annotations:{perfect:{type:'line',yMin:0,yMax:1,xMin:-0.5,xMax:cal.length-0.5,borderColor:'rgba(255,255,255,0.15)',borderDash:[5,5],borderWidth:1}}},
          tooltip:{callbacks:{label:c=>fmtPct(c.parsed.y)+' ('+cal[c.dataIndex].count+' trades)'}}
        }
      }
    });
  }

  // â”€â”€ Category horizontal bar â”€â”€
  if (marketsSorted.length) {
    const ctx3 = $('chartCategory').getContext('2d');
    destroyChart('category');
    STATE.charts.category = new Chart(ctx3, {
      type:'bar',
      data:{
        labels: marketsSorted.map(([m])=>m.length>25?m.slice(0,22)+'...':m),
        datasets:[{
          data: marketsSorted.map(([,s])=>s.pnl),
          backgroundColor: marketsSorted.map(([,s])=>s.pnl>=0?'rgba(0,211,149,0.65)':'rgba(255,59,92,0.65)'),
          borderRadius:3,borderSkipped:false
        }]
      },
      options:{
        responsive:true,maintainAspectRatio:false,animation:false,
        indexAxis:'y',
        scales:{
          y:{ticks:{font:{size:10},autoSkip:false},grid:{display:false}},
          x:{ticks:{callback:v=>'$'+v,font:{family:"'IBM Plex Mono'",size:10}},grid:{color:'rgba(136,150,171,0.05)'}}
        },
        plugins:{
          annotation:{annotations:{zero:{type:'line',xMin:0,xMax:0,borderColor:'rgba(136,150,171,0.2)',borderWidth:1}}},
          tooltip:{callbacks:{label:c=>{const m=marketsSorted[c.dataIndex];return fmt(m[1].pnl)+' Â· '+m[1].count+' trades Â· '+fmtPct(m[1].wins/Math.max(m[1].count,1))+' win';}}}
        }
      }
    });
  }

  loadExposureHeatmap();
}


async function loadExposureHeatmap() {
  const heatWrap = $('riskHeatmapWrap');
  const alertWrap = $('riskAlertWrap');
  if (!heatWrap || !alertWrap) return;

  try {
    const r = await fetch('/api/risk/exposure-heatmap');
    const data = await r.json();

    if (data.fallback_state === 'no_open_positions') {
      heatWrap.innerHTML = '<div class="empty-desc">No open positions. Heatmap will populate when Kalshi or sports exposure is open.</div>';
      alertWrap.innerHTML = '<span class="badge badge-green">OK</span> No open exposure concentration risk.';
      return;
    }

    const maxCell = Math.max(...(data.heatmap.cells||[]).map(c => Number(c.exposure_usd||0)), 1);
    const rows = data.heatmap.rows || [];
    const cols = data.heatmap.cols || [];

    let h = '<table><thead><tr><th>Source \\ Cluster</th>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr></thead><tbody>';
    for (const row of rows) {
      h += `<tr><td><span class="badge badge-blue">${row}</span></td>`;
      for (const col of cols) {
        const cell = (data.heatmap.cells||[]).find(x => x.source===row && x.cluster===col);
        const exp = Number(cell?.exposure_usd||0);
        const alpha = Math.max(0.08, exp / maxCell);
        h += `<td style="background:rgba(245,166,35,${alpha.toFixed(3)});font-family:var(--mono);">${exp>0?fmt(exp):'--'}</td>`;
      }
      h += '</tr>';
    }
    h += '</tbody></table>';

    const top = data.summary?.top_market;
    h += `<div style="margin-top:10px;color:var(--muted)">Top market: <span class="mono">${top?.name||'n/a'}</span> (${fmt(top?.exposure_usd||0)}) · HHI ${data.summary?.hhi||0}</div>`;
    heatWrap.innerHTML = h;

    const sevColor = {ok:'badge-green', warning:'badge-amber', critical:'badge-red'};
    let a = `<div style="margin-bottom:10px"><span class="badge ${sevColor[data.overall_risk]||'badge-blue'}">${(data.overall_risk||'ok').toUpperCase()}</span></div>`;
    a += '<table><thead><tr><th>Metric</th><th>Value</th><th>Status</th></tr></thead><tbody>';
    for (const item of (data.alerts||[])) {
      const val = item.metric.includes('share') ? fmtPct(item.value, 1) : (item.metric==='hhi' ? Number(item.value).toFixed(1) : fmt(item.value));
      a += `<tr><td>${item.metric}</td><td class="mono">${val}</td><td><span class="badge ${sevColor[item.level]||'badge-blue'}">${item.level.toUpperCase()}</span></td></tr>`;
    }
    a += '</tbody></table>';
    if ((data.guardrails?.missing_exposure_count||0) > 0) {
      a += `<div style="margin-top:10px;color:var(--amber)">Guardrail: ${data.guardrails.missing_exposure_count} rows had missing exposure fields and were defaulted to $0.</div>`;
    }
    alertWrap.innerHTML = a;
  } catch (e) {
    heatWrap.innerHTML = '<span class="red">Unable to load exposure heatmap.</span>';
    alertWrap.innerHTML = `<span class="red">${String(e)}</span>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB: SPORTS PICKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSports() {
            const container = app;
            if (!container) { console.error('Container not found: tab-content'); return; }
            container.innerHTML = '<div style="text-align:center;padding:40px;color:#4a5568;">Loading picks...</div>';
            fetch('/api/sports-picks')
                .then(r => r.json())
                .then(data => {
                    if (!data || !data.picks || !data.picks.length) {
                        container.innerHTML = '<div style="padding:48px;text-align:center;"><div style="font-size:32px;margin-bottom:12px;">&#127942;</div><div style="font-size:14px;font-weight:600;margin-bottom:8px;color:#e8eaf0;">No Picks Yet</div></div>';
                        return;
                    }
                    const s = data.summary;
                    const fd = (n) => (n<0?'-$':'$') + Math.abs(n).toFixed(2);
                    const fp = (n) => (n*100).toFixed(1) + '%';
                    const rb = (r) => r==='WIN'?'<span style="background:#00d395;color:#000;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;">WIN</span>':r==='LOSS'?'<span style="background:#ff3b5c;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;">LOSS</span>':'<span style="background:#f59e0b;color:#000;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;">PENDING</span>';
                    const cb = (c) => c==='HIGH'?'<span style="background:#00d395;color:#000;padding:2px 8px;border-radius:4px;font-size:11px;">HIGH</span>':c==='LOW'?'<span style="background:#ff3b5c;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;">LOW</span>':'<span style="background:#f59e0b;color:#000;padding:2px 8px;border-radius:4px;font-size:11px;">'+(c||'MED')+'</span>';
                    let h = '<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:16px;">';
                    h += '<div style="background:#0d1321;border:1px solid #1a2035;border-radius:8px;padding:16px;border-top:3px solid #00d395;"><div style="font-size:10px;text-transform:uppercase;color:#4a5568;margin-bottom:6px;">Record</div><div style="display:flex;align-items:baseline;gap:4px;"><span style="font-size:22px;font-weight:700;color:#00d395;">'+s.wins+'</span><span style="color:#4a5568;">-</span><span style="font-size:22px;font-weight:700;color:#ff3b5c;">'+s.losses+'</span></div><div style="font-size:11px;color:#4a5568;">'+s.pending+' pending</div></div>';
                    h += '<div style="background:#0d1321;border:1px solid #1a2035;border-radius:8px;padding:16px;border-top:3px solid #4f8ef7;"><div style="font-size:10px;text-transform:uppercase;color:#4a5568;margin-bottom:6px;">Win Rate</div><div style="font-size:22px;font-weight:700;color:'+(s.win_rate>=0.5?'#00d395':'#ff3b5c')+';">'+fp(s.win_rate)+'</div><div style="font-size:11px;color:#4a5568;">'+s.settled+' settled</div></div>';
                    h += '<div style="background:#0d1321;border:1px solid #1a2035;border-radius:8px;padding:16px;border-top:3px solid '+(s.total_pl>=0?'#00d395':'#ff3b5c')+';"><div style="font-size:10px;text-transform:uppercase;color:#4a5568;margin-bottom:6px;">Net P&L</div><div style="font-size:22px;font-weight:700;color:'+(s.total_pl>=0?'#00d395':'#ff3b5c')+';">'+fd(s.total_pl)+'</div></div>';
                    h += '<div style="background:#0d1321;border:1px solid #1a2035;border-radius:8px;padding:16px;border-top:3px solid #f59e0b;"><div style="font-size:10px;text-transform:uppercase;color:#4a5568;margin-bottom:6px;">Staked</div><div style="font-size:22px;font-weight:700;color:#f59e0b;">'+fd(s.total_staked)+'</div></div>';
                    h += '<div style="background:#0d1321;border:1px solid #1a2035;border-radius:8px;padding:16px;border-top:3px solid #a78bfa;"><div style="font-size:10px;text-transform:uppercase;color:#4a5568;margin-bottom:6px;">ROI</div><div style="font-size:22px;font-weight:700;color:'+(s.roi>=0?'#00d395':'#ff3b5c')+';">'+fp(s.roi)+'</div></div>';
                    h += '</div>';
                    const confE = Object.entries(data.by_confidence||{});
                    const sportE = Object.entries(data.by_sport||{});
                    if (confE.length||sportE.length) {
                        h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">';
                        if (confE.length) {
                            h += '<div style="background:#0d1321;border:1px solid #1a2035;border-radius:8px;padding:16px;"><div style="font-size:10px;text-transform:uppercase;color:#4a5568;margin-bottom:12px;">By Confidence</div><table style="width:100%;border-collapse:collapse;font-size:12px;"><thead><tr style="border-bottom:1px solid #1a2035;"><th style="text-align:left;padding:6px;color:#4a5568;">Level</th><th style="padding:6px;color:#4a5568;">W-L</th><th style="padding:6px;color:#4a5568;">Win%</th><th style="text-align:right;padding:6px;color:#4a5568;">P&L</th></tr></thead><tbody>';
                            for (const [lv,st] of confE){const wr=st.wins/Math.max(st.wins+st.losses,1);h+='<tr style="border-bottom:1px solid #0a0f1a;"><td style="padding:6px;">'+cb(lv)+'</td><td style="padding:6px;text-align:center;font-family:monospace;">'+st.wins+'-'+st.losses+'</td><td style="padding:6px;text-align:center;color:'+(wr>=0.5?'#00d395':'#ff3b5c')+';">'+fp(wr)+'</td><td style="padding:6px;text-align:right;font-weight:700;font-family:monospace;color:'+(st.pl>=0?'#00d395':'#ff3b5c')+';">'+fd(st.pl)+'</td></tr>';}
                            h += '</tbody></table></div>';
                        }
                        if (sportE.length) {
                            h += '<div style="background:#0d1321;border:1px solid #1a2035;border-radius:8px;padding:16px;"><div style="font-size:10px;text-transform:uppercase;color:#4a5568;margin-bottom:12px;">By Sport</div><table style="width:100%;border-collapse:collapse;font-size:12px;"><thead><tr style="border-bottom:1px solid #1a2035;"><th style="text-align:left;padding:6px;color:#4a5568;">Sport</th><th style="padding:6px;color:#4a5568;">W-L</th><th style="padding:6px;color:#4a5568;">Win%</th><th style="text-align:right;padding:6px;color:#4a5568;">P&L</th></tr></thead><tbody>';
                            for (const [sp,st] of sportE){const wr=st.wins/Math.max(st.wins+st.losses,1);h+='<tr style="border-bottom:1px solid #0a0f1a;"><td style="padding:6px;"><span style="background:#4f8ef7;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;">'+sp+'</span></td><td style="padding:6px;text-align:center;font-family:monospace;">'+st.wins+'-'+st.losses+'</td><td style="padding:6px;text-align:center;color:'+(wr>=0.5?'#00d395':'#ff3b5c')+';">'+fp(wr)+'</td><td style="padding:6px;text-align:right;font-weight:700;font-family:monospace;color:'+(st.pl>=0?'#00d395':'#ff3b5c')+';">'+fd(st.pl)+'</td></tr>';}
                            h += '</tbody></table></div>';
                        }
                        h += '</div>';
                    }
                    h += '<div style="font-size:10px;text-transform:uppercase;color:#4a5568;margin:20px 0 10px;">All Picks ('+data.picks.length+')</div>';
                    h += '<div style="background:#0d1321;border:1px solid #1a2035;border-radius:8px;overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:12px;"><thead><tr style="border-bottom:1px solid #1a2035;"><th style="text-align:left;padding:8px;color:#4a5568;">Date</th><th style="text-align:left;padding:8px;color:#4a5568;">Game</th><th style="text-align:left;padding:8px;color:#4a5568;">Pick</th><th style="padding:8px;color:#4a5568;">ML</th><th style="padding:8px;color:#4a5568;">Edge</th><th style="padding:8px;color:#4a5568;">Conf</th><th style="padding:8px;color:#4a5568;">Result</th><th style="text-align:right;padding:8px;color:#4a5568;">P&L</th></tr></thead><tbody>';
                    for (const p of data.picks) {
                        const ml=parseInt(p.ml)||0; const pl=parseFloat(p.profit_loss||0);
                        h+='<tr style="border-bottom:1px solid #0a0f1a;">';
                        h+='<td style="padding:8px;font-family:monospace;font-size:11px;color:#4a5568;">'+((p.pick_date||'').slice(0,10))+'</td>';
                        h+='<td style="padding:8px;font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#e8eaf0;">'+p.game+'</td>';
                        h+='<td style="padding:8px;font-size:12px;font-weight:600;color:#e8eaf0;">'+p.pick+'</td>';
                        h+='<td style="padding:8px;font-family:monospace;font-size:11px;text-align:center;color:'+(ml>0?'#00d395':'#e8eaf0')+';">'+(ml>0?'+':'')+ml+'</td>';
                        h+='<td style="padding:8px;font-family:monospace;font-size:11px;text-align:center;color:#00d395;">'+(p.edge_val?'+'+parseFloat(p.edge_val).toFixed(1)+'%':'--')+'</td>';
                        h+='<td style="padding:8px;text-align:center;">'+cb(p.confidence)+'</td>';
                        h+='<td style="padding:8px;text-align:center;">'+rb(p.result)+'</td>';
                        h+='<td style="padding:8px;text-align:right;font-family:monospace;font-weight:700;color:'+(p.result==='PENDING'?'#4a5568':pl>=0?'#00d395':'#ff3b5c')+';">'+(p.result==='PENDING'?'--':fd(pl))+'</td>';
                        h+='</tr>';
                    }
                    h += '</tbody></table></div>';
                    if (data.parlays && data.parlays.length) {
                        h += '<div style="font-size:10px;text-transform:uppercase;color:#4a5568;margin:20px 0 10px;">Parlays</div>';
                        h += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;">';
                        for (const p of data.parlays) {
                            let legs=[]; try{legs=JSON.parse(p.legs);}catch(e){legs=[p.legs];}
                            h+='<div style="background:#0d1321;border:1px solid #1a2035;border-radius:8px;padding:16px;">';
                            h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;"><span style="font-weight:600;color:#e8eaf0;">'+p.name+'</span>'+rb(p.result)+'</div>';
                            h+='<div style="font-size:11px;color:#4a5568;margin-bottom:6px;">'+p.date+' | Odds: <span style="color:#f59e0b;">'+p.odds+'</span> | Stake: '+fd(p.stake)+'</div>';
                            h+='<div style="font-size:11px;color:#4a5568;">'+legs.map(l=>'&#8226; '+l).join('<br>')+'</div></div>';
                        }
                        h += '</div>';
                    }
                    container.innerHTML = h;
                })
                .catch(err => {
                    container.innerHTML = '<div style="padding:32px;text-align:center;color:#ff3b5c;">Error: '+err+'</div>';
                });
        }
function renderJohn() {
  const container = app;
  if (!container) { console.error('Container not found: tab-content'); return; }
  container.innerHTML = '<div style="text-align:center;padding:40px;color:#4a5568;">Loading John\'s business data...</div>';
  
  // Fetch both jobs and leads
  Promise.all([
    fetch('/api/john/jobs').then(r => r.json()).catch(() => ({jobs: []})),
    fetch('/api/john/leads').then(r => r.json()).catch(() => ({leads: []})),
    fetch('/api/dashboard').then(r => r.json()).catch(() => ({}))
  ]).then(([jobsData, leadsData, dashData]) => {
    const jobs = jobsData.jobs || [];
    const leads = leadsData.leads || [];
    const actualCashRevenue = Number(dashData.john_revenue || 0);
    
    // Calculate metrics
    const paidRevenue = jobs.filter(j => j.paid).reduce((sum, j) => sum + (j.invoice_amount || 0), 0);
    const pipelineRevenue = jobs.filter(j => !j.paid && ['quoted','in_progress'].includes((j.status || '').toLowerCase())).reduce((sum, j) => sum + (j.invoice_amount || 0), 0);
    const activeJobs = jobs.filter(j => j.status === 'in_progress').length;
    const completedJobs = jobs.filter(j => j.status === 'completed').length;
    const quotedJobs = jobs.filter(j => j.status === 'quoted').length;
    const conversionRate = leads.length > 0 ? (jobs.length / leads.length * 100).toFixed(1) : 0;
    
    // Group by status for display
    const statusCounts = {};
    jobs.forEach(j => {
      statusCounts[j.status] = (statusCounts[j.status] || 0) + 1;
    });
    
    let h = '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px;">';
    h += '<div style="background:#0d1321;border:1px solid #1a2035;border-radius:8px;padding:16px;border-top:3px solid #00d395;"><div style="font-size:10px;text-transform:uppercase;color:#4a5568;margin-bottom:6px;">Cash Collected (Actual)</div><div style="font-size:22px;font-weight:700;color:#00d395;">$' + actualCashRevenue.toFixed(2) + '</div><div style="font-size:10px;color:#4a5568;margin-top:4px;">From revenue ledger only</div></div>';
    h += '<div style="background:#0d1321;border:1px solid #1a2035;border-radius:8px;padding:16px;border-top:3px solid #4f8ef7;"><div style="font-size:10px;text-transform:uppercase;color:#4a5568;margin-bottom:6px;">Pipeline (Potential)</div><div style="font-size:22px;font-weight:700;color:#4f8ef7;">$' + pipelineRevenue.toFixed(2) + '</div><div style="font-size:10px;color:#4a5568;margin-top:4px;">Excluded from net profit</div></div>';
    h += '<div style="background:#0d1321;border:1px solid #1a2035;border-radius:8px;padding:16px;border-top:3px solid #f59e0b;"><div style="font-size:10px;text-transform:uppercase;color:#4a5568;margin-bottom:6px;">Active Jobs</div><div style="font-size:22px;font-weight:700;color:#f59e0b;">' + activeJobs + '</div></div>';
    h += '<div style="background:#0d1321;border:1px solid #1a2035;border-radius:8px;padding:16px;border-top:3px solid #a78bfa;"><div style="font-size:10px;text-transform:uppercase;color:#4a5568;margin-bottom:6px;">Leads</div><div style="font-size:22px;font-weight:700;color:#a78bfa;">' + leads.length + '</div></div>';
    h += '</div>';
    
    // Status breakdown
    h += '<div style="background:#0d1321;border:1px solid #1a2035;border-radius:8px;padding:16px;margin-bottom:16px;">';
    h += '<div style="font-size:10px;text-transform:uppercase;color:#4a5568;margin-bottom:12px;">Job Status Breakdown</div>';
    h += '<div style="display:flex;gap:16px;">';
    h += '<div style="flex:1;text-align:center;padding:12px;background:#0a0f1a;border-radius:6px;"><div style="font-size:20px;font-weight:700;color:#00d395;">' + (statusCounts.completed || 0) + '</div><div style="font-size:10px;color:#4a5568;">Completed</div></div>';
    h += '<div style="flex:1;text-align:center;padding:12px;background:#0a0f1a;border-radius:6px;"><div style="font-size:20px;font-weight:700;color:#f59e0b;">' + (statusCounts.in_progress || 0) + '</div><div style="font-size:10px;color:#4a5568;">In Progress</div></div>';
    h += '<div style="flex:1;text-align:center;padding:12px;background:#0a0f1a;border-radius:6px;"><div style="font-size:20px;font-weight:700;color:#4f8ef7;">' + (statusCounts.quoted || 0) + '</div><div style="font-size:10px;color:#4a5568;">Quoted</div></div>';
    h += '<div style="flex:1;text-align:center;padding:12px;background:#0a0f1a;border-radius:6px;"><div style="font-size:20px;font-weight:700;color:#a78bfa;">' + conversionRate + '%</div><div style="font-size:10px;color:#4a5568;">Conversion</div></div>';
    h += '</div></div>';
    
    // Jobs table
    if (jobs.length > 0) {
      h += '<div style="font-size:10px;text-transform:uppercase;color:#4a5568;margin:20px 0 10px;">All Jobs (' + jobs.length + ')</div>';
      h += '<div style="background:#0d1321;border:1px solid #1a2035;border-radius:8px;overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:12px;"><thead><tr style="border-bottom:1px solid #1a2035;"><th style="text-align:left;padding:8px;color:#4a5568;">Date</th><th style="text-align:left;padding:8px;color:#4a5568;">Client</th><th style="text-align:left;padding:8px;color:#4a5568;">Description</th><th style="padding:8px;color:#4a5568;">Status</th><th style="padding:8px;color:#4a5568;">Paid</th><th style="text-align:right;padding:8px;color:#4a5568;">Amount</th></tr></thead><tbody>';
      for (const j of jobs.slice(0, 50)) {
        const statusColor = j.status === 'completed' ? '#00d395' : j.status === 'in_progress' ? '#f59e0b' : '#4f8ef7';
        h += '<tr style="border-bottom:1px solid #0a0f1a;">';
        h += '<td style="padding:8px;font-family:monospace;font-size:11px;color:#4a5568;">' + (j.job_date || '').slice(0, 10) + '</td>';
        h += '<td style="padding:8px;font-size:12px;font-weight:600;color:#e8eaf0;">' + j.client_name + '</td>';
        h += '<td style="padding:8px;font-size:11px;color:#4a5568;">' + (j.job_description || '').slice(0, 40) + '</td>';
        h += '<td style="padding:8px;text-align:center;"><span style="background:' + statusColor + ';color:#000;padding:2px 8px;border-radius:4px;font-size:11px;text-transform:uppercase;">' + j.status + '</span></td>';
        h += '<td style="padding:8px;text-align:center;">' + (j.paid ? 'âœ“' : 'â—‹') + '</td>';
        h += '<td style="padding:8px;text-align:right;font-family:monospace;font-weight:700;color:' + (j.paid ? '#00d395' : '#e8eaf0') + ';">$' + (j.invoice_amount || 0).toFixed(2) + '</td>';
        h += '</tr>';
      }
      h += '</tbody></table></div>';
    }
    
    // Leads section
    if (leads.length > 0) {
      h += '<div style="font-size:10px;text-transform:uppercase;color:#4a5568;margin:20px 0 10px;">Recent Leads (' + leads.length + ' total)</div>';
      h += '<div style="background:#0d1321;border:1px solid #1a2035;border-radius:8px;overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:12px;"><thead><tr style="border-bottom:1px solid #1a2035;"><th style="text-align:left;padding:8px;color:#4a5568;">Date</th><th style="text-align:left;padding:8px;color:#4a5568;">Client</th><th style="text-align:left;padding:8px;color:#4a5568;">Service</th><th style="text-align:left;padding:8px;color:#4a5568;">Status</th><th style="text-align:right;padding:8px;color:#4a5568;">Est. Value</th></tr></thead><tbody>';
      for (const l of leads.slice(0, 20)) {
        h += '<tr style="border-bottom:1px solid #0a0f1a;">';
        h += '<td style="padding:8px;font-family:monospace;font-size:11px;color:#4a5568;">' + (l.lead_date || '').slice(0, 10) + '</td>';
        h += '<td style="padding:8px;font-size:12px;color:#e8eaf0;">' + l.client_name + '</td>';
        h += '<td style="padding:8px;font-size:11px;color:#4a5568;">' + (l.service || '-') + '</td>';
        h += '<td style="padding:8px;"><span style="background:#1a2240;color:#4f8ef7;padding:2px 8px;border-radius:4px;font-size:11px;">' + (l.status || 'new') + '</span></td>';
        h += '<td style="padding:8px;text-align:right;font-family:monospace;">$' + (l.estimated_value || 0).toFixed(2) + '</td>';
        h += '</tr>';
      }
      h += '</tbody></table></div>';
    }
    
    container.innerHTML = h;
  }).catch(err => {
    container.innerHTML = '<div style="padding:32px;text-align:center;color:#ff3b5c;">Error loading data: ' + err + '</div>';
  });
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function queueException(type, title, detail, priority, owner, status, slaMins, source) {
  return { type, title, detail, priority, owner, status, slaMins, source };
}

function buildExceptionQueue(d, h) {
  const items = [];
  const freshness = h?.freshness?.sources || {};
  Object.entries(freshness).forEach(([src, v]) => {
    if (v?.is_stale) {
      const overBy = Math.max(0, (v.age_minutes ?? (v.max_age_minutes||0)) - (v.max_age_minutes||0));
      const pri = Math.min(100, 60 + Math.round(overBy * 0.6) + ((v.status !== 'success') ? 12 : 0));
      const sla = Math.max(0, (v.max_age_minutes || 60) - (v.age_minutes || 0));
      items.push(queueException('Stale Feed', `${src} sync stale`, `Status ${v.status || 'unknown'} • age ${(v.age_minutes ?? '—')}m`, pri, 'Data Ops', v.status === 'success' ? 'Open' : 'Investigate', sla, src));
    }
  });

  const delta = d?.kalshi_reconciliation?.delta_snapshot_minus_legacy || {};
  const reconMagnitude = Math.abs(delta.betting_net || 0);
  if (reconMagnitude >= 25 || Math.abs(delta.total_trades || 0) >= 3) {
    const pri = Math.min(100, 68 + Math.round(reconMagnitude / 3) + Math.abs(delta.total_trades || 0) * 2);
    items.push(queueException('Reconciliation', 'Snapshot vs legacy mismatch', `Net Δ ${fmt(delta.betting_net || 0)} • Trades Δ ${delta.total_trades || 0}`, pri, 'Trading Ops', 'Open', 120, 'kalshi_reconciliation'));
  }

  const caps = d?.cost_caps?.caps || {};
  Object.entries(caps).forEach(([provider, cap]) => {
    const projected = cap?.projected_month_end_usd || 0;
    const capUsd = cap?.cap_usd || 0;
    if (capUsd <= 0) return;
    const over = projected - capUsd;
    if (over > 0 || projected / capUsd > 0.9) {
      const pri = over > 0 ? Math.min(100, 80 + Math.round(over)) : Math.round(58 + (projected / capUsd) * 20);
      const status = over > 0 ? 'Escalate' : 'Watch';
      const sla = over > 0 ? 60 : 24 * 60;
      items.push(queueException('Cap Breach', `${provider} budget risk`, `Projected ${fmt(projected)} vs cap ${fmt(capUsd)} (${over > 0 ? '+' : ''}${fmt(over)})`, pri, 'FinOps', status, sla, provider));
    }
  });

  const periods = d?.kalshi_periods || {};
  const today = periods.today?.pnl_usd ?? null;
  const week = periods.week?.pnl_usd ?? null;
  if (today != null && week != null) {
    const baseline = Math.max(25, Math.abs(week) / 5);
    if (Math.abs(today) > baseline * 2) {
      const pri = Math.min(100, 64 + Math.round((Math.abs(today) - baseline * 2) / 5));
      const trend = today < 0 ? 'downside shock' : 'upside spike';
      items.push(queueException('P&L Delta', `Unusual daily P&L ${trend}`, `Today ${fmt(today)} vs baseline ±${fmt(baseline)}/day`, pri, 'Risk', today < 0 ? 'Investigate' : 'Review', 180, 'kalshi_periods'));
    }
  }

  return items.sort((a,b)=>b.priority-a.priority).slice(0,8);
}

function renderExceptions(d, h) {
  const q = buildExceptionQueue(d, h);
  const high = q.filter(x=>x.priority>=80).length;
  const med = q.filter(x=>x.priority>=60 && x.priority<80).length;

  app.innerHTML = `
  <div class="card card-p">
    <div class="exq-head">
      <div>
        <div class="card-header" style="margin-bottom:8px">Executive Exception Queue</div>
        <div style="font:500 11px/1.3 var(--font);color:var(--text2)">Actionable only: stale feeds, reconciliation, cap risk, and unusual P&L moves.</div>
      </div>
      <div class="exq-metrics">
        <div class="exq-chip">${q.length} Open</div>
        <div class="exq-chip" style="color:var(--red)">${high} High</div>
        <div class="exq-chip" style="color:var(--amber)">${med} Medium</div>
      </div>
    </div>
    ${q.length ? `
      <div style="overflow-x:auto">
      <table class="exq-table">
        <thead><tr><th>Priority</th><th>Issue</th><th>Owner</th><th>Status</th><th>SLA</th></tr></thead>
        <tbody>
          ${q.map(i=>`<tr>
            <td><div class="exq-pri" style="color:${i.priority>=80?'var(--red)':i.priority>=60?'var(--amber)':'var(--blue)'}">${i.priority}</div><div class="exq-note">${i.type}</div></td>
            <td><div class="exq-owner">${i.title}</div><div class="exq-note">${i.detail}</div></td>
            <td><span class="badge badge-blue">${i.owner}</span></td>
            <td><span class="badge ${i.status==='Escalate' || i.status==='Investigate'?'badge-red':i.status==='Watch' || i.status==='Review'?'badge-amber':'badge-purple'}">${i.status}</span></td>
            <td><span class="exq-sla" style="color:${i.slaMins<=60?'var(--red)':i.slaMins<=240?'var(--amber)':'var(--text2)'}">${i.slaMins<=0?'Overdue':i.slaMins<60?`${i.slaMins}m`:`${Math.ceil(i.slaMins/60)}h`}</span></td>
          </tr>`).join('')}
        </tbody>
      </table>
      </div>` : `<div class="empty"><div class="empty-icon">✅</div><div class="empty-title">No actionable exceptions</div><div class="empty-desc">All monitored feeds and controls are currently within thresholds.</div></div>`}
  </div>`;
}

// TAB: COST DRILL-DOWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCosts(d) {
  const spend = d.openrouter_total_spend||0;
  const left = d.openrouter_credits_remaining||0;
  const total = spend+left;
  const pctUsed = spend/Math.max(total,1);
  const net = d.betting_net - spend;
  const roi = spend>0 ? (d.betting_net/spend)*100 : 0;
  const caps = d.cost_caps?.caps || {};
  const anth = caps.anthropic || {mtd_burn_usd:0, projected_month_end_usd:0, delta_to_cap_usd:200, cap_usd:200, status:'under'};
  const oai = caps.openai_chatgpt || {mtd_burn_usd:0, projected_month_end_usd:0, delta_to_cap_usd:200, cap_usd:200, status:'under'};

  app.innerHTML = `
  <div class="section-title">API Cost Analysis</div>
  <div class="grid g4" style="margin-bottom:12px">
    ${kpi('OpenRouter Actual Spend', spend, {color:'var(--amber)', border:'var(--amber)', sub:'Latest lifetime from OpenRouter aggregate'})}
    ${kpi('Credits Remaining', left, {color:left<50?'var(--red)':'var(--green)', border:left<50?'var(--red)':'var(--green)', sub:left<50?'âš  Top up soon':'Healthy'})}
    ${kpi('% Credits Used', fmtPct(pctUsed), {color:'var(--amber)', border:'var(--amber)', raw:true})}
    ${kpi('Revenue / API Cost', roi.toFixed(1)+'%', {color:roi>100?'var(--green)':'var(--red)', border:roi>100?'var(--green)':'var(--red)', raw:true, sub:roi>100?'Profitable':'Spending > earning'})}
  </div>

  <div class="grid g2" style="margin-bottom:12px">
    <div class="card card-p" style="border-left:3px solid ${anth.status==='over'?'var(--red)':'var(--green)'}">
      <div class="card-header">Anthropic Budget Cap ($${(anth.cap_usd||200).toFixed(0)}/mo)</div>
      <table>
        <tbody>
          <tr><td>MTD Burn</td><td class="mono fw7">${fmt(anth.mtd_burn_usd||0)}</td></tr>
          <tr><td>Projected Month-End</td><td class="mono fw7" style="color:${(anth.projected_month_end_usd||0)>(anth.cap_usd||200)?'var(--red)':'var(--green)'}">${fmt(anth.projected_month_end_usd||0)}</td></tr>
          <tr><td>Cap Delta</td><td class="mono fw7" style="color:${(anth.delta_to_cap_usd||0)>=0?'var(--green)':'var(--red)'}">${(anth.delta_to_cap_usd||0)>=0?'+':''}${fmt(anth.delta_to_cap_usd||0)}</td></tr>
        </tbody>
      </table>
    </div>
    <div class="card card-p" style="border-left:3px solid ${oai.status==='over'?'var(--red)':'var(--green)'}">
      <div class="card-header">ChatGPT/OpenAI Budget Cap ($${(oai.cap_usd||200).toFixed(0)}/mo)</div>
      <table>
        <tbody>
          <tr><td>MTD Burn</td><td class="mono fw7">${fmt(oai.mtd_burn_usd||0)}</td></tr>
          <tr><td>Projected Month-End</td><td class="mono fw7" style="color:${(oai.projected_month_end_usd||0)>(oai.cap_usd||200)?'var(--red)':'var(--green)'}">${fmt(oai.projected_month_end_usd||0)}</td></tr>
          <tr><td>Cap Delta</td><td class="mono fw7" style="color:${(oai.delta_to_cap_usd||0)>=0?'var(--green)':'var(--red)'}">${(oai.delta_to_cap_usd||0)>=0?'+':''}${fmt(oai.delta_to_cap_usd||0)}</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card card-p" style="margin-bottom:12px">
    <div class="card-header">Credit Usage Progress</div>
    <div style="height:14px;background:#1a2240;border-radius:7px;overflow:hidden;margin-bottom:8px">
      <div style="height:100%;width:${(pctUsed*100).toFixed(1)}%;background:${pctUsed>0.9?'var(--red)':pctUsed>0.7?'var(--amber)':'var(--green)'};border-radius:7px;transition:width .5s"></div>
    </div>
    <div style="display:flex;justify-content:space-between;font:500 10px/1 var(--font);color:var(--muted)">
      <span>$0</span><span>${fmt(total)} total credits</span>
    </div>
    ${left<50?`<div style="margin-top:14px;padding:12px 16px;background:var(--red-dim);border:1px solid rgba(255,59,92,0.3);border-radius:8px;font:600 12px/1.4 var(--font);color:var(--red)">âš  Only ${fmt(left)} remaining on OpenRouter. Top up to keep all 3 agents running.</div>`:''}
  </div>

  <div class="card card-p">
    <div class="card-header">Cost Efficiency Summary</div>
    <table>
      <thead><tr><th>Metric</th><th>Value</th><th>Assessment</th></tr></thead>
      <tbody>
        <tr><td>Betting Revenue</td><td class="mono fw7 green">${fmt(d.betting_wins)}</td><td><span class="badge badge-green">Revenue</span></td></tr>
        <tr><td>Betting Losses</td><td class="mono fw7 red">${fmt(d.betting_losses)}</td><td><span class="badge badge-red">Cost of trading</span></td></tr>
        <tr><td>API Spend (OpenRouter)</td><td class="mono fw7 amber">${fmt(spend)}</td><td><span class="badge badge-amber">Infrastructure</span></td></tr>
        <tr><td>Net After All Costs</td><td class="mono fw7" style="color:${clr(net)}">${fmt(net)}</td><td><span class="badge ${net>=0?'badge-green':'badge-red'}">${net>=0?'Profitable':'Unprofitable'}</span></td></tr>
        <tr><td>Cost per Trade</td><td class="mono">${fmt(spend/Math.max(d.total_trades,1))}</td><td><span class="badge badge-blue">Efficiency</span></td></tr>
      </tbody>
    </table>
  </div>`;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB: LEDGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ledgerPage = 0;
const PER_PAGE = 30;

function renderLedger() {
  if (!STATE.trades) {
    app.innerHTML = '<div class="loading">Loading trades...</div>';
    return;
  }
  const trades = STATE.trades;
  const total = trades.length;
  const pages = Math.ceil(total/PER_PAGE);
  ledgerPage = Math.min(ledgerPage, Math.max(pages-1, 0));
  const slice = trades.slice(ledgerPage*PER_PAGE, (ledgerPage+1)*PER_PAGE);

  app.innerHTML = `
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <div style="font:500 12px/1 var(--font);color:var(--muted)">${fmtNum(total)} total trades</div>
    <div class="pagination">
      <button class="page-btn" id="prevPage" ${ledgerPage===0?'disabled':''}>â† Prev</button>
      <span class="page-info">${ledgerPage+1} / ${pages}</span>
      <button class="page-btn" id="nextPage" ${ledgerPage>=pages-1?'disabled':''}>Next â†’</button>
    </div>
  </div>
  <div class="card" style="overflow-x:auto">
    <table>
      <thead><tr>
        <th>Date</th><th>Market</th><th>Contract</th><th>Dir</th><th>Entry</th><th>Exit</th><th>Qty</th><th>Fees</th><th>Status</th><th>P&L</th>
      </tr></thead>
      <tbody>
      ${slice.map(t=>{
        const e=parseFloat(t.entry_price||0), x=parseFloat(t.exit_price||0), q=parseFloat(t.num_contracts||0), f=parseFloat(t.fees||0);
        const pnl = t.status==='Settled'?(x-e)*q-f:null;
        return `<tr>
          <td class="mono" style="font-size:11px;color:var(--muted)">${(t.trade_date||'').slice(0,10)}</td>
          <td><span class="badge badge-blue" style="font-size:9px">${(t.market||'Other').slice(0,20)}</span></td>
          <td style="font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${t.contract_id||''}">${t.contract_id||'â€”'}</td>
          <td><span class="badge ${t.direction==='YES'?'badge-green':'badge-red'}">${t.direction||'YES'}</span></td>
          <td class="mono" style="font-size:11px">${e?(e*100).toFixed(0)+'Â¢':'â€”'}</td>
          <td class="mono" style="font-size:11px">${x?(x*100).toFixed(0)+'Â¢':'â€”'}</td>
          <td class="mono" style="font-size:11px">${fmtNum(q)}</td>
          <td class="mono" style="font-size:11px;color:var(--muted)">${fmt(f)}</td>
          <td><span class="badge ${t.status==='Settled'?'badge-purple':'badge-amber'}">${t.status||'â€”'}</span></td>
          <td class="mono fw7" style="color:${pnl!==null?clr(pnl):'var(--muted)'}">${pnl!==null?((pnl>=0?'+':'')+fmt(pnl)):'â€”'}</td>
        </tr>`;
      }).join('')}
      </tbody>
    </table>
  </div>
  <div class="pagination" style="margin-top:12px">
    <button class="page-btn" id="prevPage2" ${ledgerPage===0?'disabled':''}>â† Prev</button>
    <span class="page-info">${ledgerPage+1} / ${pages}</span>
    <button class="page-btn" id="nextPage2" ${ledgerPage>=pages-1?'disabled':''}>Next â†’</button>
  </div>`;

  // Wire pagination
  const wire = (id, delta) => {
    const el = $(id);
    if(el) el.onclick = () => { ledgerPage += delta; renderLedger(); };
  };
  wire('prevPage', -1); wire('nextPage', 1);
  wire('prevPage2', -1); wire('nextPage2', 1);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROUTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderContent() {
  destroyAllCharts();
  const d = STATE.data;
  if (!d && STATE.tab !== 'sports' && STATE.tab !== 'john') {
    app.innerHTML = '<div class="loading">âš¡ Loading Command Center...</div>';
    return;
  }
  switch(STATE.tab) {
    case 'exceptions': renderExceptions(d, STATE.health); break;
    case 'pnl':    renderPnL(d); break;
    case 'kalshi': renderKalshi(d); break;
    case 'sports': renderSports(); break;
    case 'john':   renderJohn(); break;
    case 'costs':  renderCosts(d); break;
    case 'ledger': renderLedger(); break;
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA FETCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchDashboard() {
  try {
    const r = await fetch('/api/dashboard');
    if (!r.ok) throw new Error('API '+r.status);
    STATE.data = await r.json();
    $('lastUpdate').textContent = 'Updated ' + new Date().toLocaleTimeString();
    renderContent();
  } catch(e) {
    if (!STATE.data) {
      app.innerHTML = `<div class="error">âš  Dashboard Error: ${e.message}<br><button class="retry-btn" onclick="fetchDashboard()">Retry</button></div>`;
    }
  }
}

async function fetchTrades() {
  try {
    const r = await fetch('/api/kalshi-trades');
    if (!r.ok) return;
    const data = await r.json();
    STATE.trades = data.trades || [];
    if (STATE.tab === 'ledger') renderLedger();
  } catch(e) { /* silent */ }
}

async function fetchHealth() {
  try {
    const r = await fetch('/api/health');
    if (!r.ok) return;
    STATE.health = await r.json();
    if (STATE.tab === 'exceptions') renderExceptions(STATE.data, STATE.health);
  } catch(e) { /* silent */ }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderTabs();
fetchDashboard();
fetchTrades();
fetchHealth();

// Auto-refresh every 60 seconds
setInterval(fetchDashboard, 60000);
setInterval(fetchTrades, 120000);
setInterval(fetchHealth, 120000);
</script>
</body>
</html>

