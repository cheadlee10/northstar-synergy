<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>NorthStar Synergy | Command Center</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.0/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#070b14;--card:#0d1224;--card-hover:#131a33;--elevated:#1a2240;
  --border:rgba(136,150,171,0.1);--border-light:rgba(136,150,171,0.06);
  --green:#00d395;--green-dim:rgba(0,211,149,0.12);
  --red:#ff3b5c;--red-dim:rgba(255,59,92,0.12);
  --blue:#4f8ef7;--blue-dim:rgba(79,142,247,0.12);
  --purple:#9b59ff;--purple-dim:rgba(155,89,255,0.12);
  --amber:#f5a623;--amber-dim:rgba(245,166,35,0.12);
  --text:#e2e8f0;--text2:#8896ab;--muted:#4a5568;
  --font:'Outfit',system-ui,sans-serif;
  --mono:'IBM Plex Mono',monospace;
}
html{font-size:14px}
body{background:var(--bg);color:var(--text);font-family:var(--font);min-height:100vh;overflow-x:hidden}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:#1a2240;border-radius:3px}

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header{position:sticky;top:0;z-index:100;background:rgba(7,11,20,0.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--border)}
.header-inner{max-width:1480px;margin:0 auto;padding:0 24px}
.header-top{display:flex;justify-content:space-between;align-items:center;padding:14px 0 0}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#4f8ef7,#9b59ff);display:flex;align-items:center;justify-content:center;font:800 15px/1 var(--mono);color:#fff;letter-spacing:-0.5px}
.logo-text h1{font-size:17px;font-weight:800;letter-spacing:-0.03em}
.logo-text span{font-size:9px;text-transform:uppercase;letter-spacing:0.12em;color:var(--text2);font-weight:600}
.header-right{display:flex;align-items:center;gap:16px}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.live-label{font:600 10px/1 var(--mono);color:var(--green);letter-spacing:0.05em}
.updated{font:500 10px/1 var(--font);color:var(--muted)}

/* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs{display:flex;gap:0;margin-top:6px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.tab{padding:10px 18px;font:600 12px/1 var(--font);color:var(--muted);background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;white-space:nowrap;transition:all .15s}
.tab:hover{color:var(--text)}
.tab.active{color:var(--blue);border-bottom-color:var(--blue)}

/* â”€â”€ Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.content{max-width:1480px;margin:0 auto;padding:20px 24px 60px}
.grid{display:grid;gap:12px}
.g2{grid-template-columns:repeat(2,1fr)}
.g3{grid-template-columns:repeat(3,1fr)}
.g4{grid-template-columns:repeat(4,1fr)}
.g6{grid-template-columns:repeat(6,1fr)}
.g8-4{grid-template-columns:2fr 1fr}
.span2{grid-column:span 2}

/* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card{background:var(--card);border:1px solid var(--border-light);border-radius:12px;overflow:hidden}
.card-p{padding:20px}
.card-header{font:700 10px/1 var(--font);color:var(--muted);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:14px}

/* â”€â”€ KPI Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kpi{padding:18px 20px;border-top:3px solid transparent;position:relative}
.kpi-label{font:600 10px/1 var(--font);color:var(--text2);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:8px}
.kpi-value{font:700 24px/1.1 var(--mono);letter-spacing:-0.02em}
.kpi-sub{font:500 11px/1.3 var(--font);color:var(--muted);margin-top:6px}
.kpi-spark{position:absolute;bottom:0;left:0;right:0;height:32px;opacity:0.4}

/* â”€â”€ Badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge{display:inline-block;padding:2px 8px;border-radius:20px;font:600 10px/1.4 var(--mono);letter-spacing:0.02em}
.badge-green{background:var(--green-dim);color:var(--green)}
.badge-red{background:var(--red-dim);color:var(--red)}
.badge-blue{background:var(--blue-dim);color:var(--blue)}
.badge-amber{background:var(--amber-dim);color:var(--amber)}
.badge-purple{background:var(--purple-dim);color:var(--purple)}

/* â”€â”€ Tables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
table{width:100%;border-collapse:collapse}
th{text-align:left;font:700 9px/1 var(--font);color:var(--muted);text-transform:uppercase;letter-spacing:0.1em;padding:10px 14px;border-bottom:1px solid var(--border)}
td{padding:10px 14px;font-size:12px;border-bottom:1px solid var(--border-light)}
tr:hover td{background:rgba(255,255,255,0.015)}
.mono{font-family:var(--mono)}
.green{color:var(--green)}.red{color:var(--red)}.blue{color:var(--blue)}.amber{color:var(--amber)}.purple{color:var(--purple)}
.fw7{font-weight:700}

/* â”€â”€ Chart containers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chart-wrap{position:relative}
.chart-wrap canvas{width:100%!important}

/* â”€â”€ Segment cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.seg{border-left:3px solid var(--blue)}
.seg-icon{font-size:20px;margin-right:8px}
.seg-name{font:700 14px/1 var(--font)}
.seg-value{font:700 28px/1.1 var(--mono);margin:12px 0 4px}
.seg-detail{font:500 11px/1.3 var(--font);color:var(--muted)}

/* â”€â”€ Loading & error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loading{padding:80px 0;text-align:center;color:var(--muted);font-size:13px}
.error{padding:40px;color:var(--red);font-family:var(--mono);font-size:12px}
.retry-btn{margin-top:12px;padding:8px 20px;background:var(--blue);color:#fff;border:none;border-radius:8px;font:600 12px/1 var(--font);cursor:pointer}

/* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty{padding:60px 0;text-align:center}
.empty-icon{font-size:36px;margin-bottom:12px}
.empty-title{font:600 15px/1 var(--font);margin-bottom:6px}
.empty-desc{font:500 12px/1.4 var(--font);color:var(--muted);max-width:320px;margin:0 auto}

/* â”€â”€ Pagination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pagination{display:flex;align-items:center;gap:10px;justify-content:flex-end;margin-top:12px}
.page-btn{padding:5px 14px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font:500 12px/1 var(--font);cursor:pointer}
.page-btn:disabled{opacity:.3;cursor:default}
.page-info{font:500 11px/1 var(--font);color:var(--muted)}

/* â”€â”€ Section title â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-title{font:700 10px/1 var(--font);color:var(--muted);text-transform:uppercase;letter-spacing:0.1em;margin:28px 0 14px}

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:1200px){.g6{grid-template-columns:repeat(3,1fr)}.g4{grid-template-columns:repeat(2,1fr)}.g8-4{grid-template-columns:1fr}}
@media(max-width:768px){.g3,.g2{grid-template-columns:1fr}.g6{grid-template-columns:repeat(2,1fr)}.tabs{gap:0}.tab{padding:10px 12px;font-size:11px}}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â• -->
<div class="header">
<div class="header-inner">
  <div class="header-top">
    <div class="logo">
      <div class="logo-icon">NS</div>
      <div class="logo-text">
        <h1>NorthStar Synergy</h1>
        <span>Intelligence Â· Operations Â· Profit</span>
      </div>
    </div>
    <div class="header-right">
      <span class="updated" id="lastUpdate"></span>
      <div style="display:flex;align-items:center;gap:6px">
        <div class="live-dot"></div>
        <span class="live-label">LIVE</span>
      </div>
    </div>
  </div>
  <div class="tabs" id="tabBar"></div>
</div>
</div>

<!-- â•â•â•â•â•â•â• CONTENT â•â•â•â•â•â•â• -->
<div class="content" id="app">
  <div class="loading">âš¡ Loading Command Center...</div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NORTHSTAR SYNERGY â€” ENTERPRISE P&L COMMAND CENTER
   Chart.js + ApexCharts Â· Vanilla JS Â· Zero build step
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ Chart.js global defaults â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Chart.defaults.color = '#8896ab';
Chart.defaults.borderColor = 'rgba(136,150,171,0.08)';
Chart.defaults.font.family = "'Outfit', system-ui, sans-serif";
Chart.defaults.font.size = 11;
Chart.defaults.plugins.legend.display = false;
Chart.defaults.plugins.tooltip.backgroundColor = '#0d1224';
Chart.defaults.plugins.tooltip.borderColor = 'rgba(136,150,171,0.2)';
Chart.defaults.plugins.tooltip.borderWidth = 1;
Chart.defaults.plugins.tooltip.cornerRadius = 8;
Chart.defaults.plugins.tooltip.titleFont = {family:"'Outfit'",weight:'600',size:11};
Chart.defaults.plugins.tooltip.bodyFont = {family:"'IBM Plex Mono'",size:11};
Chart.defaults.plugins.tooltip.padding = 10;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let STATE = { tab: 'pnl', data: null, trades: null, charts: {} };
const $ = id => document.getElementById(id);
const app = $('app');

// â”€â”€ Formatting helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt = (n, d=2) => {
  if (n == null || isNaN(n)) return '$0.00';
  return (n<0?'-$':'$') + Math.abs(n).toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d});
};
const fmtPct = (n,d=1) => isNaN(n)?'0.0%':(n*100).toFixed(d)+'%';
const fmtNum = n => isNaN(n)?'0':Number(n).toLocaleString();
const clr = (n,zero='var(--text)') => n>0?'var(--green)':n<0?'var(--red)':zero;

// â”€â”€ Chart management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function destroyChart(id) {
  if (STATE.charts[id]) { STATE.charts[id].destroy(); delete STATE.charts[id]; }
}
function destroyAllCharts() {
  Object.keys(STATE.charts).forEach(destroyChart);
}

// â”€â”€ Tab definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TABS = [
  {id:'pnl',   label:'P&L Overview'},
  {id:'kalshi', label:'âš¡ Kalshi Analytics'},
  {id:'sports', label:'Sports Picks'},
  {id:'john',  label:"John's Biz"},
  {id:'costs', label:'Cost Drill-Down'},
  {id:'ledger',label:'Ledger'},
];

// â”€â”€ Render tab bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTabs() {
  $('tabBar').innerHTML = TABS.map(t =>
    `<button class="tab${STATE.tab===t.id?' active':''}" data-tab="${t.id}">${t.label}</button>`
  ).join('');
  $('tabBar').querySelectorAll('.tab').forEach(btn => {
    btn.onclick = () => { STATE.tab = btn.dataset.tab; renderTabs(); renderContent(); };
  });
}

// â”€â”€ Build KPI card HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function kpi(label, value, opts={}) {
  const {color='var(--text)',border='transparent',sub='',raw=false} = opts;
  return `<div class="card kpi" style="border-top-color:${border}">
    <div class="kpi-label">${label}</div>
    <div class="kpi-value" style="color:${color}">${raw?value:fmt(value)}</div>
    ${sub?`<div class="kpi-sub">${sub}</div>`:''}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB: P&L OVERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPnL(d) {
  const net = d.betting_net - (d.openrouter_total_spend||0);
  const creditsLeft = d.openrouter_credits_remaining||0;

  let html = `
  <div class="grid g4" style="margin-bottom:12px">
    ${kpi('True Net P&L', net, {color:clr(net), border:net>=0?'var(--green)':'var(--red)', sub:'Betting P&L minus API costs'})}
    ${kpi('Betting Wins', d.betting_wins, {color:'var(--green)', border:'var(--green)', sub:fmtNum(d.total_trades)+' settled trades'})}
    ${kpi('Betting Losses', d.betting_losses, {color:'var(--red)', border:'var(--red)', sub:fmtPct(d.win_rate)+' win rate'})}
    ${kpi('Betting Net', d.betting_net, {color:clr(d.betting_net), border:'var(--purple)', sub:'Gross prediction market P&L'})}
  </div>
  <div class="grid g4" style="margin-bottom:12px">
    ${kpi('Sharpe Ratio', d.sharpe_ratio?.toFixed(2)||'0.00', {color:d.sharpe_ratio>=1?'var(--green)':d.sharpe_ratio>=0?'var(--amber)':'var(--red)', border:'var(--blue)', raw:true, sub:d.sharpe_ratio>=1?'Strong risk-adjusted':'Needs improvement'})}
    ${kpi('Max Drawdown', d.max_drawdown, {color:'var(--red)', border:'var(--red)', sub:'Largest peak-to-trough'})}
    ${kpi('Open Positions', fmtNum(d.open_positions), {color:'var(--blue)', border:'var(--blue)', raw:true, sub:fmt(d.open_exposure)+' exposure'})}
    ${kpi('Kelly %', fmtPct(d.kelly_pct), {color:d.kelly_pct>0?'var(--green)':'var(--red)', border:d.kelly_pct>0?'var(--green)':'var(--red)', raw:true, sub:d.kelly_pct>0?'Positive edge detected':'Negative edge â€” reduce size'})}
  </div>

  <!-- Equity curve + daily P&L -->
  <div class="grid g8-4" style="margin-bottom:12px">
    <div class="card card-p">
      <div class="card-header">Cumulative P&L â€” Equity Curve</div>
      <div class="chart-wrap" style="height:260px"><canvas id="chartEquity"></canvas></div>
    </div>
    <div class="card card-p">
      <div class="card-header">Daily P&L</div>
      <div class="chart-wrap" style="height:260px"><canvas id="chartDaily"></canvas></div>
    </div>
  </div>

  <!-- Business Units -->
  <div class="section-title">Business Units</div>
  <div class="grid g3" style="margin-bottom:12px">
    <div class="card card-p seg" style="border-left-color:var(--purple)">
      <div style="display:flex;align-items:center;margin-bottom:12px">
        <span class="seg-icon" style="color:var(--purple)">âš¡</span>
        <span class="seg-name">Scalper / Kalshi</span>
      </div>
      <div class="seg-value" style="color:${clr(d.betting_net)}">${fmt(d.betting_net)}</div>
      <div class="seg-detail">Wins: ${fmt(d.betting_wins)} Â· ${fmtNum(d.total_trades)} trades Â· ${fmtPct(d.win_rate)} win rate</div>
      <div class="seg-detail">${d.current_streak||0}${d.streak_type||'?'} streak Â· ${d.open_positions} open</div>
    </div>
    <div class="card card-p seg" style="border-left-color:var(--green)">
      <div style="display:flex;align-items:center;margin-bottom:12px">
        <span class="seg-icon" style="color:var(--green)">â—†</span>
        <span class="seg-name">John's Web Biz</span>
      </div>
      <div class="seg-value" style="color:var(--muted)">$0.00</div>
      <div class="seg-detail">Connect jobs.jsonl to sync revenue data</div>
    </div>
    <div class="card card-p seg" style="border-left-color:var(--amber)">
      <div style="display:flex;align-items:center;margin-bottom:12px">
        <span class="seg-icon" style="color:var(--amber)">âœ¦</span>
        <span class="seg-name">Kelsea</span>
      </div>
      <div class="seg-value" style="color:var(--muted)">$0.00</div>
      <div class="seg-detail">Awaiting transaction data sync</div>
    </div>
  </div>

  <!-- API Cost Banner -->
  <div class="card card-p" style="border-left:3px solid var(--amber)">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px">
      <div>
        <div class="kpi-label">OpenRouter API Spend</div>
        <div style="font:700 26px/1 var(--mono);color:var(--amber)">${fmt(d.openrouter_total_spend)}</div>
      </div>
      <div style="text-align:center">
        <div class="kpi-label">Credits Left</div>
        <div style="font:700 22px/1 var(--mono);color:${creditsLeft<50?'var(--red)':'var(--green)'}">${fmt(creditsLeft)}</div>
        ${creditsLeft<50?'<div style="font:700 10px/1 var(--font);color:var(--red);margin-top:4px">âš  TOP UP SOON</div>':''}
      </div>
      <div style="text-align:right">
        <div class="kpi-label">True Bottom Line</div>
        <div style="font:700 22px/1 var(--mono);color:${clr(net)}">${fmt(net)}</div>
        <div style="font:500 10px/1 var(--font);color:var(--muted);margin-top:4px">Betting P&L âˆ’ API costs</div>
      </div>
    </div>
  </div>`;

  app.innerHTML = html;

  // â”€â”€ Equity curve chart â”€â”€
  if (d.cumulative_pnl?.length) {
    const ctx = $('chartEquity').getContext('2d');
    const grad = ctx.createLinearGradient(0,0,0,260);
    const isPos = d.betting_net >= 0;
    grad.addColorStop(0, isPos?'rgba(0,211,149,0.25)':'rgba(255,59,92,0.25)');
    grad.addColorStop(1, 'rgba(0,0,0,0)');
    destroyChart('equity');
    STATE.charts.equity = new Chart(ctx, {
      type:'line',
      data:{
        labels: d.cumulative_pnl.map(p=>p.date),
        datasets:[{data:d.cumulative_pnl.map(p=>p.pnl),borderColor:isPos?'#00d395':'#ff3b5c',borderWidth:2,fill:true,backgroundColor:grad,tension:0.3,pointRadius:0,pointHitRadius:8}]
      },
      options:{
        responsive:true, maintainAspectRatio:false, animation:false,
        scales:{
          x:{ticks:{maxTicksLimit:8,font:{size:10}},grid:{display:false}},
          y:{ticks:{callback:v=>'$'+v,font:{family:"'IBM Plex Mono'",size:10}},grid:{color:'rgba(136,150,171,0.05)'}}
        },
        plugins:{
          annotation:{annotations:{zero:{type:'line',yMin:0,yMax:0,borderColor:'rgba(136,150,171,0.2)',borderDash:[4,4],borderWidth:1}}},
          tooltip:{callbacks:{label:ctx=>fmt(ctx.parsed.y)}}
        }
      }
    });
  }

  // â”€â”€ Daily P&L bars â”€â”€
  if (d.daily_pnl?.length) {
    const ctx2 = $('chartDaily').getContext('2d');
    destroyChart('daily');
    STATE.charts.daily = new Chart(ctx2, {
      type:'bar',
      data:{
        labels: d.daily_pnl.map(p=>p.date),
        datasets:[{
          data: d.daily_pnl.map(p=>p.pnl),
          backgroundColor: d.daily_pnl.map(p=>p.pnl>=0?'rgba(0,211,149,0.7)':'rgba(255,59,92,0.7)'),
          borderRadius:3, borderSkipped:false
        }]
      },
      options:{
        responsive:true, maintainAspectRatio:false, animation:false,
        scales:{
          x:{ticks:{maxTicksLimit:6,font:{size:9}},grid:{display:false}},
          y:{ticks:{callback:v=>'$'+v,font:{family:"'IBM Plex Mono'",size:10}},grid:{color:'rgba(136,150,171,0.05)'}}
        },
        plugins:{tooltip:{callbacks:{label:ctx=>fmt(ctx.parsed.y)}}}
      }
    });
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB: KALSHI ANALYTICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderKalshi(d) {
  const bm = d.by_market || {};
  const bd = d.by_direction || {};
  const cal = d.calibration || [];
  const tw = d.top_wins || [];
  const tl = d.top_losses || [];

  // Sort markets by P&L
  const marketsSorted = Object.entries(bm).sort((a,b)=>b[1].pnl-a[1].pnl);

  let html = `
  <!-- Top metrics row -->
  <div class="grid g6" style="margin-bottom:12px">
    ${kpi('Total P&L', d.betting_net, {color:clr(d.betting_net), border:clr(d.betting_net)})}
    ${kpi('Win Rate', fmtPct(d.win_rate), {color:'var(--blue)', border:'var(--blue)', raw:true, sub:(d.unique_contracts||0)+'W / '+(Math.round((d.unique_contracts||0)*(1-(d.win_rate||0))))+'L by contract'})}
    ${kpi('Sharpe', (d.sharpe_ratio||0).toFixed(2), {color:d.sharpe_ratio>=1?'var(--green)':'var(--amber)', border:'var(--blue)', raw:true, sub:d.sharpe_ratio>=1?'Strong':'Needs work'})}
    ${kpi('Max Drawdown', d.max_drawdown, {color:'var(--red)', border:'var(--red)', sub:'Peak-to-trough loss'})}
    ${kpi('Kelly %', fmtPct(d.kelly_pct), {color:d.kelly_pct>0?'var(--green)':'var(--red)', border:d.kelly_pct>0?'var(--green)':'var(--red)', raw:true, sub:d.kelly_pct>0?'Edge present':'Negative edge'})}
    ${kpi('Avg Win / Loss', '', {border:'var(--purple)', raw:true, sub:`<span class="green">${fmt(d.avg_win)}</span> / <span class="red">${fmt(d.avg_loss)}</span>`})}
  </div>

  <!-- Equity + Calibration row -->
  <div class="grid g2" style="margin-bottom:12px">
    <div class="card card-p">
      <div class="card-header">Cumulative P&L â€” Equity Curve (Last 200 Trades)</div>
      <div class="chart-wrap" style="height:220px"><canvas id="chartEquityK"></canvas></div>
    </div>
    <div class="card card-p">
      <div class="card-header">Calibration â€” Entry Price vs Actual Win Rate</div>
      <div style="font:500 10px/1.3 var(--font);color:var(--muted);margin-bottom:10px">Bars above the diagonal = underconfident pricing (good). Below = overpaying.</div>
      <div class="chart-wrap" style="height:190px"><canvas id="chartCalibration"></canvas></div>
    </div>
  </div>

  <!-- Market category + Direction -->
  <div class="grid g2" style="margin-bottom:12px">
    <div class="card card-p">
      <div class="card-header">P&L by Market Category</div>
      <div class="chart-wrap" style="height:${Math.max(180, marketsSorted.length*32)}px"><canvas id="chartCategory"></canvas></div>
    </div>
    <div class="card card-p">
      <div class="card-header">YES vs NO Performance</div>
      <table>
        <thead><tr><th>Direction</th><th>Trades</th><th>Win Rate</th><th>Net P&L</th></tr></thead>
        <tbody>
          ${Object.entries(bd).map(([dir,s])=>`<tr>
            <td><span class="badge ${dir==='YES'?'badge-green':'badge-red'}">${dir}</span></td>
            <td class="mono">${fmtNum(s.count)}</td>
            <td style="color:${s.wins/Math.max(s.count,1)>0.5?'var(--green)':'var(--red)'}">
              ${fmtPct(s.wins/Math.max(s.count,1))}
            </td>
            <td class="mono fw7" style="color:${clr(s.pnl)}">${fmt(s.pnl)}</td>
          </tr>`).join('')}
        </tbody>
      </table>

      <div class="card-header" style="margin-top:20px">Open Positions (${d.open_positions})</div>
      <div style="max-height:160px;overflow-y:auto;font-size:11px;color:var(--muted)">
        ${d.open_positions>0?'View in Ledger tab for full details.':'No open positions.'}
      </div>
    </div>
  </div>

  <!-- Top Wins & Losses -->
  <div class="grid g2">
    <div class="card card-p">
      <div class="card-header green">ğŸ† Top 5 Wins</div>
      <table>
        <thead><tr><th>Market</th><th>Entry</th><th>P&L</th></tr></thead>
        <tbody>${tw.map(t=>`<tr>
          <td style="font-size:11px;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.market||'â€”'}</td>
          <td class="mono" style="font-size:11px">${t.entry?((t.entry*100).toFixed(0)+'Â¢'):'â€”'}</td>
          <td class="mono fw7 green">+${fmt(t.pnl)}</td>
        </tr>`).join('')}</tbody>
      </table>
    </div>
    <div class="card card-p">
      <div class="card-header red">ğŸ’€ Top 5 Losses</div>
      <table>
        <thead><tr><th>Market</th><th>Entry</th><th>P&L</th></tr></thead>
        <tbody>${tl.map(t=>`<tr>
          <td style="font-size:11px;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.market||'â€”'}</td>
          <td class="mono" style="font-size:11px">${t.entry?((t.entry*100).toFixed(0)+'Â¢'):'â€”'}</td>
          <td class="mono fw7 red">${fmt(t.pnl)}</td>
        </tr>`).join('')}</tbody>
      </table>
    </div>
  </div>`;

  app.innerHTML = html;

  // â”€â”€ Equity Curve (Kalshi tab) â”€â”€
  if (d.cumulative_pnl?.length) {
    const ctx = $('chartEquityK').getContext('2d');
    const grad = ctx.createLinearGradient(0,0,0,220);
    const pos = d.betting_net>=0;
    grad.addColorStop(0, pos?'rgba(0,211,149,0.2)':'rgba(255,59,92,0.2)');
    grad.addColorStop(1, 'rgba(0,0,0,0)');
    destroyChart('equityK');
    STATE.charts.equityK = new Chart(ctx, {
      type:'line',
      data:{
        labels:d.cumulative_pnl.map(p=>p.date),
        datasets:[{data:d.cumulative_pnl.map(p=>p.pnl),borderColor:pos?'#00d395':'#ff3b5c',borderWidth:2,fill:true,backgroundColor:grad,tension:0.3,pointRadius:0}]
      },
      options:{
        responsive:true,maintainAspectRatio:false,animation:false,
        scales:{
          x:{ticks:{maxTicksLimit:6,font:{size:9}},grid:{display:false}},
          y:{ticks:{callback:v=>'$'+v,font:{family:"'IBM Plex Mono'",size:10}},grid:{color:'rgba(136,150,171,0.05)'}}
        },
        plugins:{
          annotation:{annotations:{zero:{type:'line',yMin:0,yMax:0,borderColor:'rgba(136,150,171,0.15)',borderDash:[4,4],borderWidth:1}}},
          tooltip:{callbacks:{label:c=>fmt(c.parsed.y)}}
        }
      }
    });
  }

  // â”€â”€ Calibration bar chart â”€â”€
  if (cal.length) {
    const ctx2 = $('chartCalibration').getContext('2d');
    destroyChart('calibration');
    STATE.charts.calibration = new Chart(ctx2, {
      type:'bar',
      data:{
        labels: cal.map(c=>c.range+'Â¢'),
        datasets:[{
          data: cal.map(c=>c.actual_win_rate),
          backgroundColor: cal.map(c=>c.actual_win_rate>0.5?'rgba(0,211,149,0.7)':'rgba(255,59,92,0.7)'),
          borderRadius:4,borderSkipped:false
        }]
      },
      options:{
        responsive:true,maintainAspectRatio:false,animation:false,
        indexAxis:'x',
        scales:{
          x:{ticks:{font:{size:10}},grid:{display:false}},
          y:{min:0,max:1,ticks:{callback:v=>(v*100)+'%',stepSize:0.25,font:{family:"'IBM Plex Mono'",size:10}},grid:{color:'rgba(136,150,171,0.05)'}}
        },
        plugins:{
          annotation:{annotations:{perfect:{type:'line',yMin:0,yMax:1,xMin:-0.5,xMax:cal.length-0.5,borderColor:'rgba(255,255,255,0.15)',borderDash:[5,5],borderWidth:1}}},
          tooltip:{callbacks:{label:c=>fmtPct(c.parsed.y)+' ('+cal[c.dataIndex].count+' trades)'}}
        }
      }
    });
  }

  // â”€â”€ Category horizontal bar â”€â”€
  if (marketsSorted.length) {
    const ctx3 = $('chartCategory').getContext('2d');
    destroyChart('category');
    STATE.charts.category = new Chart(ctx3, {
      type:'bar',
      data:{
        labels: marketsSorted.map(([m])=>m.length>25?m.slice(0,22)+'...':m),
        datasets:[{
          data: marketsSorted.map(([,s])=>s.pnl),
          backgroundColor: marketsSorted.map(([,s])=>s.pnl>=0?'rgba(0,211,149,0.65)':'rgba(255,59,92,0.65)'),
          borderRadius:3,borderSkipped:false
        }]
      },
      options:{
        responsive:true,maintainAspectRatio:false,animation:false,
        indexAxis:'y',
        scales:{
          y:{ticks:{font:{size:10},autoSkip:false},grid:{display:false}},
          x:{ticks:{callback:v=>'$'+v,font:{family:"'IBM Plex Mono'",size:10}},grid:{color:'rgba(136,150,171,0.05)'}}
        },
        plugins:{
          annotation:{annotations:{zero:{type:'line',xMin:0,xMax:0,borderColor:'rgba(136,150,171,0.2)',borderWidth:1}}},
          tooltip:{callbacks:{label:c=>{const m=marketsSorted[c.dataIndex];return fmt(m[1].pnl)+' Â· '+m[1].count+' trades Â· '+fmtPct(m[1].wins/Math.max(m[1].count,1))+' win';}}}
        }
      }
    });
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB: SPORTS PICKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSports() {
    const container = document.getElementById('tab-content');
    container.innerHTML = '<div style="text-align:center;padding:40px;color:#4a5568;">Loading sports picks...</div>';

    fetch('/api/sports-picks')
        .then(r => r.json())
        .then(data => {
            if (!data || !data.picks || !data.picks.length) {
                container.innerHTML = `
                    <div class="card" style="padding:48px;text-align:center;">
                        <div style="font-size:32px;margin-bottom:12px;">&#127942;</div>
                        <div style="font-size:14px;font-weight:600;margin-bottom:8px;color:#e8eaf0;">No Sports Picks Yet</div>
                        <div style="font-size:12px;color:#4a5568;">Run backfill_picks.py to populate.</div>
                    </div>`;
                return;
            }

            const s = data.summary;
            const fmtD = (n) => (n<0?'-$':'$') + Math.abs(n).toFixed(2);
            const fmtP = (n) => (n*100).toFixed(1) + '%';
            const rBadge = (r) => r==='WIN' ? '<span class="badge badge-green">WIN</span>' : r==='LOSS' ? '<span class="badge badge-red">LOSS</span>' : '<span class="badge badge-amber">PENDING</span>';
            const cBadge = (c) => c==='HIGH' ? '<span class="badge badge-green">HIGH</span>' : c==='LOW' ? '<span class="badge badge-red">LOW</span>' : '<span class="badge badge-amber">'+(c||'MED')+'</span>';

            const settled = data.picks.filter(p => p.result==='WIN'||p.result==='LOSS');
            let cum = 0;
            const cumData = settled
                .sort((a,b) => (a.pick_date||'').localeCompare(b.pick_date||'') || a.id-b.id)
                .map(p => { cum += parseFloat(p.profit_loss||0); return { date: (p.pick_date||'').slice(5,10), pnl: cum, game: p.game }; });

            let html = `
            <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:12px;">
                <div class="card" style="padding:16px;border-top:3px solid var(--green);">
                    <div class="metric-label">Record</div>
                    <div style="display:flex;align-items:baseline;gap:4px;">
                        <span class="metric-value" style="color:var(--green);font-size:22px;">${s.wins}</span>
                        <span style="color:var(--muted);font-size:14px;">-</span>
                        <span class="metric-value" style="color:var(--red);font-size:22px;">${s.losses}</span>
                    </div>
                    <div class="metric-sub">${s.pending} pending</div>
                </div>
                <div class="card" style="padding:16px;border-top:3px solid var(--blue);">
                    <div class="metric-label">Win Rate</div>
                    <div class="metric-value" style="color:${s.win_rate>=0.5?'var(--green)':'var(--red)'};font-size:22px;">${fmtP(s.win_rate)}</div>
                    <div class="metric-sub">${s.settled} settled</div>
                </div>
                <div class="card" style="padding:16px;border-top:3px solid ${s.total_pl>=0?'var(--green)':'var(--red)'};">
                    <div class="metric-label">Net P&L</div>
                    <div class="metric-value" style="color:${s.total_pl>=0?'var(--green)':'var(--red)'};font-size:22px;">${fmtD(s.total_pl)}</div>
                </div>
                <div class="card" style="padding:16px;border-top:3px solid var(--amber);">
                    <div class="metric-label">Total Staked</div>
                    <div class="metric-value" style="color:var(--amber);font-size:22px;">${fmtD(s.total_staked)}</div>
                </div>
                <div class="card" style="padding:16px;border-top:3px solid var(--purple);">
                    <div class="metric-label">ROI</div>
                    <div class="metric-value" style="color:${s.roi>=0?'var(--green)':'var(--red)'};font-size:22px;">${fmtP(s.roi)}</div>
                    <div class="metric-sub">Return on staked</div>
                </div>
            </div>`;

            // By Confidence + By Sport
            html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">`;

            html += `<div class="card" style="padding:20px;">
                <div class="metric-label" style="margin-bottom:12px;">By Confidence</div>
                <table><thead><tr><th>Level</th><th>W-L</th><th>Win%</th><th>P&L</th></tr></thead><tbody>`;
            for (const [level, stats] of Object.entries(data.by_confidence || {})) {
                const wr = stats.wins / Math.max(stats.wins+stats.losses, 1);
                html += '<tr><td>'+cBadge(level)+'</td><td class="mono" style="font-size:12px;">'+stats.wins+'-'+stats.losses+'</td>';
                html += '<td style="color:'+(wr>=0.5?'var(--green)':'var(--red)')+'">'+fmtP(wr)+'</td>';
                html += '<td class="mono" style="font-weight:700;color:'+(stats.pl>=0?'var(--green)':'var(--red)')+'">'+fmtD(stats.pl)+'</td></tr>';
            }
            html += `</tbody></table></div>`;

            html += `<div class="card" style="padding:20px;">
                <div class="metric-label" style="margin-bottom:12px;">By Sport</div>
                <table><thead><tr><th>Sport</th><th>W-L</th><th>Win%</th><th>P&L</th></tr></thead><tbody>`;
            for (const [sport, stats] of Object.entries(data.by_sport || {})) {
                const wr = stats.wins / Math.max(stats.wins+stats.losses, 1);
                html += '<tr><td><span class="badge badge-blue">'+sport+'</span></td><td class="mono" style="font-size:12px;">'+stats.wins+'-'+stats.losses+'</td>';
                html += '<td style="color:'+(wr>=0.5?'var(--green)':'var(--red)')+'">'+fmtP(wr)+'</td>';
                html += '<td class="mono" style="font-weight:700;color:'+(stats.pl>=0?'var(--green)':'var(--red)')+'">'+fmtD(stats.pl)+'</td></tr>';
            }
            html += `</tbody></table></div></div>`;

            // Pick log table
            html += `<div class="metric-label" style="margin:20px 0 12px;">All Picks</div>`;
            html += `<div class="card" style="overflow-x:auto;">
                <table><thead><tr>
                    <th>Date</th><th>Game</th><th>Pick</th><th>ML</th><th>Edge</th><th>Conf</th><th>Result</th><th>P&L</th>
                </tr></thead><tbody>`;
            for (const p of data.picks) {
                const ml = parseInt(p.ml)||0;
                const pl = parseFloat(p.profit_loss||0);
                html += '<tr>';
                html += '<td class="mono" style="font-size:11px;color:var(--muted);">'+(p.pick_date||'').slice(0,10)+'</td>';
                html += '<td style="font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+p.game+'</td>';
                html += '<td style="font-size:12px;font-weight:600;">'+p.pick+'</td>';
                html += '<td class="mono" style="font-size:11px;color:'+(ml>0?'var(--green)':'var(--text)')+';">'+(ml>0?'+':'')+ml+'</td>';
                html += '<td class="mono" style="font-size:11px;color:var(--green);">'+(p.edge_val ? '+'+parseFloat(p.edge_val).toFixed(1)+'%' : '--')+'</td>';
                html += '<td>'+cBadge(p.confidence)+'</td>';
                html += '<td>'+rBadge(p.result)+'</td>';
                html += '<td class="mono" style="font-weight:700;color:'+(p.result==='PENDING'?'var(--muted)':pl>=0?'var(--green)':'var(--red)')+';">'+(p.result==='PENDING'?'--':(pl>=0?'+':'')+fmtD(pl))+'</td>';
                html += '</tr>';
            }
            html += `</tbody></table></div>`;

            container.innerHTML = html;
        })
        .catch(err => {
            container.innerHTML = '<div class="card" style="padding:32px;text-align:center;color:var(--red);">Error loading sports picks: '+err+'</div>';
        });
}

function renderJohn() {
  app.innerHTML = `<div class="card card-p empty">
    <div class="empty-icon">â—†</div>
    <div class="empty-title">John's Web Development Business</div>
    <div class="empty-desc">Connect <code>jobs.jsonl</code> and <code>leads.jsonl</code> from John's workspace to populate revenue tracking, pipeline status, MRR, and client metrics.</div>
    <div class="section-title" style="margin-top:24px">Metrics Available Once Connected</div>
    <div class="grid g3" style="gap:10px;max-width:600px;margin:12px auto 0">
      ${['Pipeline Revenue','Active Jobs','MRR Tracking','Client Conversion Rate','Revenue by Service','Lead Source Analysis'].map(m=>
        `<div class="card card-p" style="text-align:center;font:500 11px/1.3 var(--font);color:var(--text2);padding:12px">${m}</div>`
      ).join('')}
    </div>
  </div>`;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB: COST DRILL-DOWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCosts(d) {
  const spend = d.openrouter_total_spend||0;
  const left = d.openrouter_credits_remaining||0;
  const total = spend+left;
  const pctUsed = spend/Math.max(total,1);
  const net = d.betting_net - spend;
  const roi = spend>0 ? (d.betting_net/spend)*100 : 0;

  app.innerHTML = `
  <div class="section-title">API Cost Analysis</div>
  <div class="grid g4" style="margin-bottom:12px">
    ${kpi('Total API Spend', spend, {color:'var(--amber)', border:'var(--amber)'})}
    ${kpi('Credits Remaining', left, {color:left<50?'var(--red)':'var(--green)', border:left<50?'var(--red)':'var(--green)', sub:left<50?'âš  Top up soon':'Healthy'})}
    ${kpi('% Credits Used', fmtPct(pctUsed), {color:'var(--amber)', border:'var(--amber)', raw:true})}
    ${kpi('Revenue / API Cost', roi.toFixed(1)+'%', {color:roi>100?'var(--green)':'var(--red)', border:roi>100?'var(--green)':'var(--red)', raw:true, sub:roi>100?'Profitable':'Spending > earning'})}
  </div>

  <div class="card card-p" style="margin-bottom:12px">
    <div class="card-header">Credit Usage Progress</div>
    <div style="height:14px;background:#1a2240;border-radius:7px;overflow:hidden;margin-bottom:8px">
      <div style="height:100%;width:${(pctUsed*100).toFixed(1)}%;background:${pctUsed>0.9?'var(--red)':pctUsed>0.7?'var(--amber)':'var(--green)'};border-radius:7px;transition:width .5s"></div>
    </div>
    <div style="display:flex;justify-content:space-between;font:500 10px/1 var(--font);color:var(--muted)">
      <span>$0</span><span>${fmt(total)} total credits</span>
    </div>
    ${left<50?`<div style="margin-top:14px;padding:12px 16px;background:var(--red-dim);border:1px solid rgba(255,59,92,0.3);border-radius:8px;font:600 12px/1.4 var(--font);color:var(--red)">âš  Only ${fmt(left)} remaining on OpenRouter. Top up to keep all 3 agents running.</div>`:''}
  </div>

  <div class="card card-p">
    <div class="card-header">Cost Efficiency Summary</div>
    <table>
      <thead><tr><th>Metric</th><th>Value</th><th>Assessment</th></tr></thead>
      <tbody>
        <tr><td>Betting Revenue</td><td class="mono fw7 green">${fmt(d.betting_wins)}</td><td><span class="badge badge-green">Revenue</span></td></tr>
        <tr><td>Betting Losses</td><td class="mono fw7 red">${fmt(d.betting_losses)}</td><td><span class="badge badge-red">Cost of trading</span></td></tr>
        <tr><td>API Spend (OpenRouter)</td><td class="mono fw7 amber">${fmt(spend)}</td><td><span class="badge badge-amber">Infrastructure</span></td></tr>
        <tr><td>Net After All Costs</td><td class="mono fw7" style="color:${clr(net)}">${fmt(net)}</td><td><span class="badge ${net>=0?'badge-green':'badge-red'}">${net>=0?'Profitable':'Unprofitable'}</span></td></tr>
        <tr><td>Cost per Trade</td><td class="mono">${fmt(spend/Math.max(d.total_trades,1))}</td><td><span class="badge badge-blue">Efficiency</span></td></tr>
      </tbody>
    </table>
  </div>`;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB: LEDGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ledgerPage = 0;
const PER_PAGE = 30;

function renderLedger() {
  if (!STATE.trades) {
    app.innerHTML = '<div class="loading">Loading trades...</div>';
    return;
  }
  const trades = STATE.trades;
  const total = trades.length;
  const pages = Math.ceil(total/PER_PAGE);
  ledgerPage = Math.min(ledgerPage, Math.max(pages-1, 0));
  const slice = trades.slice(ledgerPage*PER_PAGE, (ledgerPage+1)*PER_PAGE);

  app.innerHTML = `
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <div style="font:500 12px/1 var(--font);color:var(--muted)">${fmtNum(total)} total trades</div>
    <div class="pagination">
      <button class="page-btn" id="prevPage" ${ledgerPage===0?'disabled':''}>â† Prev</button>
      <span class="page-info">${ledgerPage+1} / ${pages}</span>
      <button class="page-btn" id="nextPage" ${ledgerPage>=pages-1?'disabled':''}>Next â†’</button>
    </div>
  </div>
  <div class="card" style="overflow-x:auto">
    <table>
      <thead><tr>
        <th>Date</th><th>Market</th><th>Contract</th><th>Dir</th><th>Entry</th><th>Exit</th><th>Qty</th><th>Fees</th><th>Status</th><th>P&L</th>
      </tr></thead>
      <tbody>
      ${slice.map(t=>{
        const e=parseFloat(t.entry_price||0), x=parseFloat(t.exit_price||0), q=parseFloat(t.num_contracts||0), f=parseFloat(t.fees||0);
        const pnl = t.status==='Settled'?(x-e)*q-f:null;
        return `<tr>
          <td class="mono" style="font-size:11px;color:var(--muted)">${(t.trade_date||'').slice(0,10)}</td>
          <td><span class="badge badge-blue" style="font-size:9px">${(t.market||'Other').slice(0,20)}</span></td>
          <td style="font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${t.contract_id||''}">${t.contract_id||'â€”'}</td>
          <td><span class="badge ${t.direction==='YES'?'badge-green':'badge-red'}">${t.direction||'YES'}</span></td>
          <td class="mono" style="font-size:11px">${e?(e*100).toFixed(0)+'Â¢':'â€”'}</td>
          <td class="mono" style="font-size:11px">${x?(x*100).toFixed(0)+'Â¢':'â€”'}</td>
          <td class="mono" style="font-size:11px">${fmtNum(q)}</td>
          <td class="mono" style="font-size:11px;color:var(--muted)">${fmt(f)}</td>
          <td><span class="badge ${t.status==='Settled'?'badge-purple':'badge-amber'}">${t.status||'â€”'}</span></td>
          <td class="mono fw7" style="color:${pnl!==null?clr(pnl):'var(--muted)'}">${pnl!==null?((pnl>=0?'+':'')+fmt(pnl)):'â€”'}</td>
        </tr>`;
      }).join('')}
      </tbody>
    </table>
  </div>
  <div class="pagination" style="margin-top:12px">
    <button class="page-btn" id="prevPage2" ${ledgerPage===0?'disabled':''}>â† Prev</button>
    <span class="page-info">${ledgerPage+1} / ${pages}</span>
    <button class="page-btn" id="nextPage2" ${ledgerPage>=pages-1?'disabled':''}>Next â†’</button>
  </div>`;

  // Wire pagination
  const wire = (id, delta) => {
    const el = $(id);
    if(el) el.onclick = () => { ledgerPage += delta; renderLedger(); };
  };
  wire('prevPage', -1); wire('nextPage', 1);
  wire('prevPage2', -1); wire('nextPage2', 1);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROUTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderContent() {
  destroyAllCharts();
  const d = STATE.data;
  if (!d && STATE.tab !== 'sports' && STATE.tab !== 'john') {
    app.innerHTML = '<div class="loading">âš¡ Loading Command Center...</div>';
    return;
  }
  switch(STATE.tab) {
    case 'pnl':    renderPnL(d); break;
    case 'kalshi': renderKalshi(d); break;
    case 'sports': renderSports(); break;
    case 'john':   renderJohn(); break;
    case 'costs':  renderCosts(d); break;
    case 'ledger': renderLedger(); break;
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA FETCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchDashboard() {
  try {
    const r = await fetch('/api/dashboard');
    if (!r.ok) throw new Error('API '+r.status);
    STATE.data = await r.json();
    $('lastUpdate').textContent = 'Updated ' + new Date().toLocaleTimeString();
    renderContent();
  } catch(e) {
    if (!STATE.data) {
      app.innerHTML = `<div class="error">âš  Dashboard Error: ${e.message}<br><button class="retry-btn" onclick="fetchDashboard()">Retry</button></div>`;
    }
  }
}

async function fetchTrades() {
  try {
    const r = await fetch('/api/kalshi-trades');
    if (!r.ok) return;
    const data = await r.json();
    STATE.trades = data.trades || [];
    if (STATE.tab === 'ledger') renderLedger();
  } catch(e) { /* silent */ }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderTabs();
fetchDashboard();
fetchTrades();

// Auto-refresh every 60 seconds
setInterval(fetchDashboard, 60000);
setInterval(fetchTrades, 120000);
</script>
</body>
</html>
