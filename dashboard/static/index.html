<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NorthStar Synergy | Enterprise P&L</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap');
        :root {
            --bg: #06080f;
            --card: #0c1021;
            --accent: #6366f1;
            --green: #10b981;
            --red: #ef4444;
            --text: #f1f5f9;
            --text-muted: #64748b;
        }
        body { background-color: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; margin: 0; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 3px; }
        .glass-card { background: rgba(12,16,33,0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
        const { useState, useEffect } = React;

        const fmt = (n) => {
            if (n === undefined || n === null || isNaN(n)) return "$0.00";
            return (n < 0 ? "-$" : "$") + Math.abs(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        const fmtPct = (n) => {
            if (!n) return "0.0%";
            return (n * 100).toFixed(1) + "%";
        };

        const KPICard = ({ label, value, color, border, raw }) =>
            React.createElement('div', { className: 'glass-card rounded-xl p-5 border-t-4 ' + border },
                React.createElement('div', { className: 'text-xs font-bold text-slate-400 uppercase tracking-wider mb-2' }, label),
                React.createElement('div', { className: 'text-2xl font-mono font-bold', style: { color: color } },
                    raw ? value : fmt(value)
                )
            );

        const Dashboard = () => {
            const [period, setPeriod] = useState("MTD");
            const [data, setData] = useState(null);
            const [error, setError] = useState(null);
            const [lastUpdated, setLastUpdated] = useState(null);

            const loadData = () => {
                fetch('/api/dashboard')
                    .then(r => {
                        if (!r.ok) throw new Error('API returned ' + r.status);
                        return r.json();
                    })
                    .then(d => {
                        setData(d);
                        setLastUpdated(new Date().toLocaleTimeString());
                        setError(null);
                    })
                    .catch(e => setError(e.toString()));
            };

            useEffect(() => {
                loadData();
                const interval = setInterval(loadData, 60000);
                return () => clearInterval(interval);
            }, []);

            if (error) return React.createElement('div', { style: { color: '#ef4444', padding: '2rem', fontFamily: 'monospace' } },
                React.createElement('h2', null, '⚠ Dashboard Error'),
                React.createElement('pre', null, error),
                React.createElement('button', { onClick: loadData, style: { marginTop: '1rem', padding: '0.5rem 1rem', background: '#6366f1', color: 'white', border: 'none', borderRadius: '6px', cursor: 'pointer' } }, 'Retry')
            );

            if (!data) return React.createElement('div', { style: { color: '#64748b', padding: '4rem', textAlign: 'center', fontSize: '1.2rem' } }, '⚡ Loading Command Center...');

            const bettingNet = data.betting_net || 0;
            const bettingWins = data.betting_wins || 0;
            const bettingLosses = data.betting_losses || 0;
            const openPositions = data.open_positions || 0;
            const openExposure = data.open_exposure || 0;
            const winRate = data.win_rate || 0;
            const totalTrades = data.total_trades || 0;
            const apiSpend = data.openrouter_total_spend || 0;
            const creditsLeft = data.openrouter_credits_remaining || 0;
            const totalNet = bettingNet - apiSpend;

            const kpis = [
                { label: 'Total Net P&L', value: totalNet, color: totalNet >= 0 ? '#10b981' : '#ef4444', border: 'border-t-indigo-500' },
                { label: 'Betting Wins', value: bettingWins, color: '#10b981', border: 'border-t-emerald-500' },
                { label: 'Betting Losses', value: bettingLosses, color: '#ef4444', border: 'border-t-rose-500' },
                { label: 'Betting Net', value: bettingNet, color: bettingNet >= 0 ? '#10b981' : '#ef4444', border: 'border-t-purple-500' },
                { label: 'Open Positions', value: openPositions, color: '#6366f1', border: 'border-t-indigo-400', raw: true },
                { label: 'Open Exposure', value: openExposure, color: '#f59e0b', border: 'border-t-amber-500' },
                { label: 'Win Rate', value: fmtPct(winRate), color: '#10b981', border: 'border-t-emerald-400', raw: true },
                { label: 'Total Trades', value: totalTrades.toLocaleString(), color: '#94a3b8', border: 'border-t-slate-500', raw: true },
            ];

            return React.createElement('div', { className: 'min-h-screen pb-20' },

                // ── HEADER
                React.createElement('div', { className: 'border-b border-slate-800 bg-slate-900/80 backdrop-blur sticky top-0 z-50' },
                    React.createElement('div', { className: 'max-w-7xl mx-auto px-6 py-4 flex justify-between items-center' },
                        React.createElement('div', { className: 'flex items-center gap-3' },
                            React.createElement('div', {
                                style: { width: 40, height: 40, borderRadius: 10, background: 'linear-gradient(135deg,#6366f1,#8b5cf6)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 900, fontSize: 16, color: 'white' }
                            }, 'NS'),
                            React.createElement('div', null,
                                React.createElement('div', { style: { fontWeight: 700, fontSize: 18, letterSpacing: '-0.02em' } }, 'NorthStar Synergy'),
                                React.createElement('div', { style: { fontSize: 10, textTransform: 'uppercase', letterSpacing: '0.1em', color: '#64748b', fontWeight: 600 } }, 'P&L Command Center')
                            )
                        ),
                        React.createElement('div', { className: 'flex items-center gap-4' },
                            React.createElement('div', { style: { fontSize: 11, color: '#64748b' } }, lastUpdated ? 'Updated ' + lastUpdated : ''),
                            React.createElement('div', { className: 'flex bg-slate-800/50 rounded-lg p-1 border border-slate-700' },
                                ['Today','7D','MTD','QTD','All'].map(p =>
                                    React.createElement('button', {
                                        key: p,
                                        onClick: () => setPeriod(p),
                                        style: {
                                            padding: '4px 12px',
                                            fontSize: 11,
                                            fontWeight: 700,
                                            borderRadius: 6,
                                            border: 'none',
                                            cursor: 'pointer',
                                            background: period === p ? '#6366f1' : 'transparent',
                                            color: period === p ? 'white' : '#94a3b8',
                                            transition: 'all 0.15s'
                                        }
                                    }, p)
                                )
                            ),
                            React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 6 } },
                                React.createElement('div', { style: { width: 8, height: 8, borderRadius: '50%', background: '#10b981', animation: 'pulse 2s infinite' } }),
                                React.createElement('span', { style: { fontSize: 11, fontWeight: 700, color: '#10b981' } }, 'LIVE')
                            )
                        )
                    )
                ),

                // ── MAIN
                React.createElement('div', { className: 'max-w-7xl mx-auto px-6 py-8' },

                    // KPI Grid
                    React.createElement('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4 mb-8' },
                        kpis.map(k => React.createElement(KPICard, Object.assign({ key: k.label }, k)))
                    ),

                    // Business Units
                    React.createElement('div', { className: 'mb-8' },
                        React.createElement('div', { style: { fontSize: 11, fontWeight: 700, color: '#64748b', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 16 } }, 'Business Units'),
                        React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4' },
                            [
                                { name: 'Scalper / Kalshi', net: bettingNet, rev: bettingWins, color: '#6366f1', icon: '⚡', detail: totalTrades + ' trades · ' + fmtPct(winRate) + ' win rate' },
                                { name: "John's Web Biz", net: 0, rev: 0, color: '#10b981', icon: '◆', detail: 'Awaiting data sync' },
                                { name: 'Kelsea', net: 0, rev: 0, color: '#f59e0b', icon: '✦', detail: 'Awaiting data sync' },
                            ].map(seg =>
                                React.createElement('div', { key: seg.name, className: 'glass-card rounded-xl p-5', style: { borderLeft: '4px solid ' + seg.color } },
                                    React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 10, marginBottom: 12 } },
                                        React.createElement('span', { style: { fontSize: 20, color: seg.color } }, seg.icon),
                                        React.createElement('span', { style: { fontWeight: 700, fontSize: 14 } }, seg.name)
                                    ),
                                    React.createElement('div', { style: { fontSize: 28, fontFamily: 'JetBrains Mono, monospace', fontWeight: 700, color: seg.net >= 0 ? '#10b981' : '#ef4444', marginBottom: 4 } }, fmt(seg.net)),
                                    React.createElement('div', { style: { fontSize: 11, color: '#64748b' } }, 'Revenue: ' + fmt(seg.rev)),
                                    React.createElement('div', { style: { fontSize: 11, color: '#475569', marginTop: 4 } }, seg.detail)
                                )
                            )
                        )
                    ),

                    // API Cost Banner
                    React.createElement('div', { className: 'glass-card rounded-xl p-5', style: { borderLeft: '4px solid #f59e0b' } },
                        React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: 12 } },
                            React.createElement('div', null,
                                React.createElement('div', { style: { fontSize: 11, fontWeight: 700, color: '#64748b', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 4 } }, 'OpenRouter API Cost'),
                                React.createElement('div', { style: { fontSize: 28, fontFamily: 'JetBrains Mono, monospace', fontWeight: 700, color: '#f59e0b' } }, fmt(apiSpend))
                            ),
                            React.createElement('div', { style: { textAlign: 'right' } },
                                React.createElement('div', { style: { fontSize: 11, color: '#64748b', marginBottom: 4 } }, 'Credits Remaining'),
                                React.createElement('div', { style: { fontSize: 24, fontFamily: 'JetBrains Mono, monospace', fontWeight: 700, color: creditsLeft < 50 ? '#ef4444' : '#10b981' } }, fmt(creditsLeft)),
                                creditsLeft < 50 ? React.createElement('div', { style: { fontSize: 11, color: '#ef4444', fontWeight: 700 } }, '⚠ TOP UP SOON') : null
                            ),
                            React.createElement('div', null,
                                React.createElement('div', { style: { fontSize: 11, color: '#64748b', marginBottom: 4 } }, 'True Bottom Line'),
                                React.createElement('div', { style: { fontSize: 24, fontFamily: 'JetBrains Mono, monospace', fontWeight: 700, color: totalNet >= 0 ? '#10b981' : '#ef4444' } }, fmt(totalNet)),
                                React.createElement('div', { style: { fontSize: 11, color: '#64748b' } }, 'Betting P&L minus API costs')
                            )
                        )
                    )
                )
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(Dashboard));
    </script>
</body>
</html>